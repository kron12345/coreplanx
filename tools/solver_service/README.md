# CorePlanX Solver Service (Python + OR-Tools)

This service exposes a small HTTP API that runs OR-Tools (CP-SAT) on planning
candidates generated by the CorePlanX backend.

## Setup

```bash
cd tools/solver_service
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## Run

```bash
uvicorn app:app --host 0.0.0.0 --port 8099
```

The backend expects the solver at `http://localhost:8099` by default. Override
with `PLANNING_SOLVER_URL` in `backend/.env`.

## Endpoints

- `GET /health` basic health check
- `POST /solve` runs a CP-SAT solve on candidates

Example payload (candidates):

```json
{
  "rulesetId": "coreplanx",
  "rulesetVersion": "v1",
  "candidates": [
    {
      "id": "cand:break:1",
      "templateId": "break-30",
      "type": "break",
      "params": {
        "serviceId": "svc-1",
        "gapMinutes": 45
      }
    }
  ],
  "options": {
    "max_per_service_type": 1,
    "weight_key": "gapMinutes",
    "time_limit_seconds": 1.5
  }
}
```

Example payload (duty sequencing):

```json
{
  "rulesetId": "coreplanx",
  "rulesetVersion": "v1",
  "candidates": [],
  "problem": {
    "groups": [
      {
        "id": "svc:base:personnel-1:2026-01-15",
        "ownerId": "personnel-1",
        "ownerKind": "personnel-service",
        "dayKey": "2026-01-15",
        "activities": [
          { "id": "act-1", "startMs": 1705318800000, "endMs": 1705326000000 },
          { "id": "act-2", "startMs": 1705330800000, "endMs": 1705338000000 }
        ],
        "edges": [
          {
            "fromId": "act-1",
            "toId": "act-2",
            "gapMinutes": 60,
            "travelMinutes": 10,
            "missingTravel": false
          }
        ]
      }
    ]
  },
  "options": {
    "time_limit_seconds": 1.5
  }
}
```
