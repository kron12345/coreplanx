<section class="planning-calendar">
  <header class="planning-calendar__toolbar">
    <div>
      <h1>Planungskalender</h1>
      <p>Fahrplanjahr im Überblick, inklusive Zeiträume und Spezialtage.</p>
    </div>
    <div class="planning-calendar__controls">
      <mat-button-toggle-group [value]="stage()" (change)="onStageChange($any($event.value))" appearance="legacy">
        <mat-button-toggle value="base">Basis</mat-button-toggle>
        <mat-button-toggle value="operations">Betrieb</mat-button-toggle>
      </mat-button-toggle-group>
      <select
        class="select"
        [value]="selectedTemplate() ? selectedTemplate()!.id : ''"
        (change)="onTemplateChange($any($event.target).value)"
      >
        @for (tpl of templates(); track tpl.id) {
          <option [value]="tpl.id">{{ tpl.name || tpl.id }}</option>
        }
      </select>
      <select class="select" [value]="selectedYear().label" (change)="onYearChange($any($event.target).value)">
        @for (year of yearOptions(); track year.label) {
          <option [value]="year.label">{{ year.label }} · {{ year.startIso }} – {{ year.endIso }}</option>
        }
      </select>
      <button mat-flat-button color="primary" (click)="openGantt()">
        <mat-icon fontIcon="view_timeline"></mat-icon>
        Gantt öffnen
      </button>
      <button mat-stroked-button type="button" (click)="openPeriodsDialog()">
        Zeiträume verwalten
      </button>
    </div>
  </header>

  <mat-card class="planning-calendar__legend">
    <div class="legend__item">
      <span class="legend__swatch legend__swatch--period"></span>
      Zeitraum
    </div>
    <div class="legend__item">
      <span class="legend__swatch legend__swatch--special">★</span>
      Spezialtag
    </div>
    <div class="legend__item" *ngIf="selectedDate()">
      <strong>Ausgewählt:</strong> {{ selectedDate() }}
    </div>
  </mat-card>

  <div class="planning-calendar__grid">
    <div class="planning-calendar__header" [style.gridTemplateColumns]="gridTemplateColumns()">
      <div class="cell cell--label">Tag</div>
      @for (month of monthHeaders(); track month.key) {
        <div class="cell cell--month">{{ month.label }}</div>
      }
    </div>
    <div class="planning-calendar__rows">
      @for (row of calendarRows(); track row.day) {
        <div class="row" [style.gridTemplateColumns]="gridTemplateColumns()">
          <div class="cell cell--label">{{ row.day }}</div>
          @for (cell of row.cells; track trackCell($index, cell)) {
            <button
              class="cell cell--day"
              type="button"
              [disabled]="!cell"
              [class.is-period]="cell?.isInPeriod"
              [class.is-special]="cell?.isSpecial"
              [class.is-selected]="cell?.iso === selectedDate()"
              [class.is-range]="isInSelectionRange(cell?.iso)"
              [class.is-range-start]="isRangeStart(cell?.iso)"
              [class.is-range-end]="isRangeEnd(cell?.iso)"
              [class.is-saturday]="cell?.isSaturday"
              [class.is-sunday]="cell?.isSunday"
              [style.background]="cell ? buildBackground(cell) : ''"
              (click)="cell && onDayClick(cell)"
            >
              <span *ngIf="cell" class="day-number">{{ cell.day }}</span>
              <span *ngIf="cell" class="weekday">{{ cell.weekday }}</span>
              <span *ngIf="cell?.isSpecial" class="marker marker--special">★</span>
              <span
                *ngIf="cell?.isInPeriod"
                class="marker marker--period"
                [style.background]="cell?.periodColor || '#2f80ed'"
              ></span>
            </button>
          }
        </div>
      }
    </div>
  </div>

  <mat-card class="planning-calendar__actions" *ngIf="selectedDate()">
    <div class="actions__title">
      <mat-icon fontIcon="calendar_month"></mat-icon>
      <div>
        <div class="muted">Aktionen</div>
        <strong>{{ selectedDate() }}</strong>
      </div>
    </div>
    <div class="actions__buttons">
      <div class="actions__block">
        <div class="muted">Zeitraum</div>
        <div class="muted small">
          Klick auf einen Tag setzt zuerst Start, dann Ende. Aktuell: {{ periodStart() || '–' }} bis
          {{ periodEnd() || '–' }}
        </div>
        <div class="actions__row">
          <input type="date" [value]="periodStart()" (input)="onPeriodStartInput($event)" />
          <input type="date" [value]="periodEnd()" (input)="onPeriodEndInput($event)" />
          <button mat-stroked-button color="primary" type="button" (click)="addPeriodInline()">
            Speichern
          </button>
          <button mat-button type="button" (click)="rangeSelectionMode.set('start')">
            Auswahl zurücksetzen
          </button>
        </div>
      </div>
      <div class="actions__block">
        <div class="muted">Spezialtag</div>
        <div class="actions__row">
          <input type="date" [value]="specialDayInput()" (input)="onSpecialDayInput($event)" />
          <button mat-stroked-button type="button" (click)="addSpecialDayInline()">
            Markieren
          </button>
        </div>
      </div>
      <div class="actions__block">
        <div class="muted">Ansicht</div>
        <button mat-flat-button color="primary" type="button" (click)="openGantt()">
          <mat-icon fontIcon="view_timeline"></mat-icon>
          Gantt für Tag öffnen
        </button>
      </div>
    </div>
    <div class="actions__feedback" *ngIf="actionMessage() || actionError()">
      <span class="feedback feedback--success" *ngIf="actionMessage()">{{ actionMessage() }}</span>
      <span class="feedback feedback--error" *ngIf="actionError()">{{ actionError() }}</span>
    </div>
  </mat-card>
</section>
