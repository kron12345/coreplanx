<section class="planning-dashboard">
  <header class="planning-toolbar">
    <div class="planning-toolbar__bar">
        <div class="planning-toolbar__summary-block">
          <div class="planning-toolbar__alerts">
            @if (resourceError(); as error) {
              <div class="alert">
                <mat-icon fontIcon="error"></mat-icon>
                {{ error }}
              </div>
            }
            @if (timelineError(activeStageId()); as error) {
              <div class="alert">
                <mat-icon fontIcon="error_outline"></mat-icon>
                {{ error }}
              </div>
            }
            @if (templateError(); as error) {
              <div class="alert">
                <mat-icon fontIcon="warning"></mat-icon>
                {{ error }}
              </div>
            }
          </div>
        <span class="planning-toolbar__summary">
          {{ boards().length }} Plantafel(n) · {{ resources().length }} Ressourcen ·
          {{ selectionSize() }} ausgewählt · {{ selectedSimulationLabel() }}
        </span>
        @if (activeStageId() === 'base') {
          <button
            mat-stroked-button
            color="primary"
            class="planning-toolbar__base-toggle"
            (click)="openPeriodsWindow()"
            matTooltip="Zeiträume und Spezialtage in neuem Fenster bearbeiten."
          >
            <mat-icon fontIcon="view_week"></mat-icon>
            Zeiträume bearbeiten
          </button>
        }
      </div>

      <div class="planning-filter-bar">
        <div class="planning-filter" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="layers"></mat-icon>
            <span>{{ activeStageMeta().label }}</span>
          </button>
          <div class="planning-filter__panel">
            <div class="planning-filter__panel-title">Planungsphase</div>
            <div class="planning-filter__panel-list">
              @for (stage of stages; track stage.id) {
                <button
                  type="button"
                  class="planning-filter__option"
                  [class.is-active]="stage.id === activeStageId()"
                  (click)="onStageChange(stage.id)"
                >
                  <strong>{{ stage.label }}</strong>
                  <span>{{ stage.description }}</span>
                </button>
              }
            </div>
          </div>
        </div>

        <div class="planning-filter planning-filter--wide" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="calendar_month"></mat-icon>
            <span>{{ timetableYearSummary() }}</span>
          </button>
          <div class="planning-filter__panel planning-filter__panel--wide">
            <div class="planning-filter__panel-title">Fahrplanjahre</div>
            <div class="planning-filter__panel-actions">
              <button mat-stroked-button type="button" (click)="selectDefaultTimetableYear()">
                Aktuelles
              </button>
              <button mat-button type="button" (click)="selectAllTimetableYears()">
                Alle
              </button>
            </div>
            <div class="planning-filter__panel-list planning-filter__panel-list--resources">
              @for (year of timetableYearOptions(); track year.label) {
                <mat-checkbox
                  [checked]="isTimetableYearSelected(year.label)"
                  (change)="onTimetableYearToggle(year.label, $event.checked)"
                >
                  {{ year.label }} · {{ year.startIso }} – {{ year.endIso }}
                </mat-checkbox>
              }
            </div>
          </div>
        </div>

        <div class="planning-filter" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="science"></mat-icon>
            <span>{{ selectedSimulationLabel() }}</span>
          </button>
          <div class="planning-filter__panel">
            <div class="planning-filter__panel-title">Planungsvariante</div>
            <div class="planning-filter__panel-list">
              @if (simulationOptions().length) {
                @for (sim of simulationOptions(); track sim.id) {
                  <button
                    type="button"
                    class="planning-filter__option"
                    [class.is-active]="sim.id === selectedSimulationId()"
                    (click)="onSimulationSelect(sim.id)"
                  >
                    <strong>{{ sim.label }}</strong>
                    <span>{{ sim.productive ? 'Produktiv' : 'Simulation' }} · {{ sim.timetableYearLabel }}</span>
                  </button>
                }
              } @else {
                <p class="planning-filter__empty">Keine Varianten für die gewählten Fahrplanjahre.</p>
              }
            </div>
          </div>
        </div>

        <div class="planning-filter planning-filter--wide" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="group"></mat-icon>
            <span>Ressourcen</span>
          </button>
          <div class="planning-filter__panel planning-filter__panel--wide">
            <div class="planning-filter__panel-title">Ressourcen</div>
            <div class="planning-filter__panel-actions">
              <button mat-stroked-button (click)="selectAllResources()">Alle</button>
              <button mat-button (click)="clearSelection()">Leeren</button>
            </div>
            <div class="planning-filter__panel-groups">
              @for (group of resourceGroups(); track group.label) {
                <div class="planning-filter__panel-group">
                  <header>
                    <strong>{{ group.label }}</strong>
                    <small>{{ group.resources.length }} Ressourcen</small>
                  </header>
                  <div class="planning-filter__panel-list planning-filter__panel-list--resources">
                    @for (resource of group.resources; track resource.id) {
                      <mat-checkbox
                        [checked]="isResourceSelected(resource.id)"
                        (change)="onSelectionToggle(resource.id, $event.checked)"
                      >
                        {{ resource.name }}
                      </mat-checkbox>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        </div>

        <div class="planning-filter" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="view_week"></mat-icon>
            <span>Leistungen</span>
          </button>
          <div class="planning-filter__panel">
            <div class="planning-filter__panel-title">Leistungstypen</div>
            <div class="planning-filter__tags">
              @for (option of activityCreationOptions(); track option.id) {
                <button type="button" (click)="selectCatalogActivity(option.id)">
                  {{ option.label }}
                </button>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="planning-toolbar__quick">
        <button
          mat-icon-button
          matTooltip="Plantafel aus Auswahl"
          (click)="createBoardFromSelection()"
        >
          <mat-icon fontIcon="library_add"></mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Auswahl hinzufügen"
          [disabled]="!hasSelection()"
          [matMenuTriggerFor]="selectionAddMenu"
        >
          <mat-icon fontIcon="playlist_add"></mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Plantafel ersetzen"
          [disabled]="!hasSelection()"
          [matMenuTriggerFor]="selectionReplaceMenu"
        >
          <mat-icon fontIcon="sync_alt"></mat-icon>
        </button>
      </div>
    </div>
  </header>

  <mat-menu #selectionAddMenu="matMenu">
    @for (board of boards(); track board.id) {
      <button mat-menu-item (click)="addSelectionToBoard(board.id)">
        {{ board.title }}
      </button>
    }
  </mat-menu>

  <mat-menu #selectionReplaceMenu="matMenu">
    @for (board of boards(); track board.id) {
      <button mat-menu-item (click)="replaceBoardWithSelection(board.id)">
        {{ board.title }}
      </button>
    }
  </mat-menu>

  <mat-menu #boardActionsMenu="matMenu">
    <ng-template matMenuContent let-board="board">
      <button mat-menu-item (click)="setSelectionFromBoard(board.id)">
        Auswahl übernehmen
      </button>
      <button mat-menu-item [disabled]="!hasSelection()" (click)="addSelectionToBoard(board.id)">
        Auswahl hinzufügen
      </button>
      <button mat-menu-item [disabled]="!hasSelection()" (click)="replaceBoardWithSelection(board.id)">
        Ersetzen
      </button>
    </ng-template>
  </mat-menu>

  <section class="planning-main">
    <mat-card class="planning-main__card">
      <mat-card-content>
        <mat-tab-group
          class="planning-board-tabs"
          [selectedIndex]="selectedBoardIndex()"
          (selectedIndexChange)="handleBoardIndexChange($event)"
          animationDuration="250ms"
        >
          @for (board of boards(); track board.id) {
            <mat-tab>
              <ng-template mat-tab-label>
                <span [class.is-active]="isActiveBoard(board.id)">{{ board.title }}</span>
                <span class="planning-tab-actions">
                  <app-gantt-window-launcher
                    [stageId]="activeStageId()"
                    [boardId]="board.id"
                    [resourceIds]="board.resourceIds"
                  />
                  @if (boards().length > 1) {
                    <button
                      mat-icon-button
                      matTooltip="Plantafel schließen"
                      (click)="removeBoard(board.id); $event.stopPropagation()"
                    >
                      <mat-icon fontIcon="close"></mat-icon>
                    </button>
                  }
                </span>
              </ng-template>

              <div class="planning-board">
                @if (board.resourceIds.length > 0) {
                  <div class="planning-board__gantt">
                    <app-gantt
                      [resources]="boardResources(board)"
                      [activities]="boardActivities(board)"
                      [pendingActivity]="boardPendingActivity(board)"
                      [timelineRange]="timelineRange()"
                      [periods]="currentPeriods()"
                      [minTimelineDays]="activeStageId() === 'base' ? 8 : 30"
                      [snapTimelineToMidnight]="activeStageId() !== 'base'"
                      [resourceViewModes]="resourceViewModes()"
                      [selectedActivityIds]="selectedActivityIdsArray()"
                      [activityTypeInfo]="activityTypeInfoMap()"
                      (resourceViewModeChange)="handleResourceViewModeChange($event)"
                      (serviceAssignmentRequested)="handleServiceAssignRequest($event)"
                      (activityCreateRequested)="handleActivityCreate($event)"
                      (activityEditRequested)="handleActivityEdit($event)"
                      (activityCopyRequested)="handleActivityCopy($event)"
                      (activityRepositionRequested)="handleActivityReposition($event)"
                      (activitySelectionToggle)="handleActivitySelectionToggle($event)"
                      (removeResource)="removeResourceFromBoard(board.id, $event)"
                    >
                      <ng-container gantt-menu-actions>
                        <button
                          mat-icon-button
                          class="planning-board__menu-trigger"
                          [matMenuTriggerFor]="boardActionsMenu"
                          [matMenuTriggerData]="{ board: board }"
                          matTooltip="Aktionen"
                        >
                          <mat-icon fontIcon="more_vert"></mat-icon>
                        </button>
                      </ng-container>
                    </app-gantt>
                  </div>
                } @else {
                  <div class="planning-board__empty">
                    <mat-icon fontIcon="dashboard"></mat-icon>
                    <p>Diese Plantafel enthält noch keine Ressourcen. Bitte Auswahl hinzufügen.</p>
                  </div>
                }
              </div>
            </mat-tab>
          }
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
  </section>

  <section class="planning-side-panels">
    @if (pendingServiceResource(); as pending) {
      <mat-card>
        <mat-card-header>
          <mat-card-title>Dienst zuweisen</mat-card-title>
          <mat-card-subtitle>{{ pending.name }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p>Wähle eine Ressource aus, die diesen Dienst übernehmen soll.</p>
          <mat-form-field appearance="outline" class="planning-side-panels__field">
            <mat-label>Zielressource</mat-label>
            <mat-select
              [value]="serviceAssignmentTarget()"
              (selectionChange)="setServiceAssignmentTarget($event.value)"
            >
              @for (candidate of assignmentCandidates(); track candidate.id) {
                <mat-option [value]="candidate.id">
                  {{ candidate.name }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </mat-card-content>
        <mat-card-actions align="end">
          <button mat-button type="button" (click)="cancelServiceAssignment()">Abbrechen</button>
          <button
            mat-flat-button
            color="primary"
            type="button"
            [disabled]="!serviceAssignmentTarget()"
            (click)="confirmServiceAssignment()"
          >
            Zuweisen
          </button>
        </mat-card-actions>
      </mat-card>
    }

    @if (selectedActivities().length > 0) {
      <div class="planning-panel" cdkDrag>
        <div class="planning-panel__header" cdkDragHandle>
          <div>
            <div class="planning-panel__title">Auswahl</div>
            <div class="planning-panel__subtitle">{{ selectedActivities().length }} Aktivität(en)</div>
          </div>
          <button mat-icon-button type="button" (click)="clearActivitySelection()" aria-label="Auswahl leeren">
            <mat-icon fontIcon="close"></mat-icon>
          </button>
        </div>
        <div class="planning-panel__body">
          <mat-chip-set class="planning-selection-chips">
            @for (item of selectedActivities(); track item.activity.id) {
              <mat-chip>
                {{ activityTypeLabel(item.activity.type) }}
              </mat-chip>
            }
          </mat-chip-set>

          <mat-form-field appearance="outline" class="planning-side-panels__field">
            <mat-label>Zielressource</mat-label>
            <mat-select
              [value]="activityMoveTarget()"
              (selectionChange)="setMoveSelectionTarget($event.value)"
              [disabled]="moveTargetOptions().length === 0"
            >
              @for (resource of moveTargetOptions(); track resource.id) {
                <mat-option [value]="resource.id">
                  {{ resource.name }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>

          <div class="planning-side-panels__buttons">
            <button mat-stroked-button type="button" (click)="clearActivitySelection()">
              Auswahl leeren
            </button>
            <button
              mat-flat-button
              color="primary"
              type="button"
              (click)="moveSelectionToTarget()"
              [disabled]="!activityMoveTarget()"
            >
              Auf Ressource verschieben
            </button>
          </div>
        </div>
      </div>
    }
    @if (selectedActivity(); as selected) {
      <div class="planning-panel planning-panel--form" cdkDrag>
      <div class="planning-panel__header" cdkDragHandle>
        <div>
          <div class="planning-panel__title">
            {{ isSelectedActivityPending() ? 'Aktivität anlegen' : 'Aktivität bearbeiten' }}
          </div>
          <div class="planning-panel__subtitle">
            {{ activityTypeLabel(selected.activity.type) }}
            @if (isSelectedActivityPending()) {
              <span class="planning-panel__badge">Entwurf</span>
            }
          </div>
        </div>
        <button mat-icon-button type="button" (click)="clearSelectedActivity()" aria-label="Panel schließen">
          <mat-icon fontIcon="close"></mat-icon>
        </button>
      </div>
      <div class="planning-panel__body">
        <form [formGroup]="activityForm" class="planning-side-panels__form" (ngSubmit)="saveSelectedActivityEdits()">
          <input type="hidden" formControlName="type" />

          <div class="planning-type-summary planning-side-panels__full">
            <div class="planning-type-summary__row">
              <span class="planning-type-summary__chip">
                {{ selectedCatalogOption()?.label ?? selectedActivityDefinition()?.label ?? 'Aktivitätstyp wählen' }}
              </span>
              <button
                type="button"
                class="planning-type-summary__change"
                (click)="openTypePicker()"
              >
                Typ ändern…
              </button>
            </div>
          </div>

          @if (isSelectedActivityPending() && quickActivityTypes().length > 0) {
            <section class="planning-type-quick planning-side-panels__full">
              <div class="planning-type-quick__label">
                Typ-Schnellauswahl
              </div>
              <div class="planning-type-quick__chips">
                @for (option of quickActivityTypes(); track option.id) {
                  <button
                    type="button"
                    class="planning-type-quick__chip"
                    [class.is-selected]="isActivityOptionSelected(option.id)"
                    (click)="selectCatalogActivity(option.id)"
                  >
                    <span class="planning-type-quick__chip-label">
                      {{ option.label }}
                    </span>
                  </button>
                }
                <button
                  type="button"
                  class="planning-type-quick__chip planning-type-quick__chip--all"
                  (click)="openTypePicker()"
                >
                  Alle Typen…
                </button>
              </div>
            </section>
          }

          <section class="planning-section planning-section--time planning-side-panels__full">
            <header class="planning-section__header">
              <div class="planning-section__title">Zeit</div>
              <div class="planning-section__subtitle">
                Start, Ende, Dauer und Andocken.
              </div>
            </header>
            <div class="planning-type-editor__fields planning-type-editor__fields--full">
              <div class="planning-attribute-grid">
                <mat-form-field appearance="outline" class="planning-attribute-grid__item">
                  <mat-label>Start</mat-label>
                  <input matInput type="datetime-local" formControlName="start" />
                  @if (
                    activityForm.controls.start.invalid &&
                    (activityForm.controls.start.dirty || activityForm.controls.start.touched)
                  ) {
                    <mat-error>Startzeit ist erforderlich.</mat-error>
                  }
                </mat-form-field>
                @if (shouldShowEndField(selectedActivityDefinition())) {
                  <mat-form-field appearance="outline" class="planning-attribute-grid__item">
                    <mat-label>Ende</mat-label>
                    <input matInput type="datetime-local" formControlName="end" />
                  </mat-form-field>
                }
                @if (definitionHasField(selectedActivityDefinition(), 'from')) {
                  <mat-form-field appearance="outline" class="planning-attribute-grid__item">
                    <mat-label>Von</mat-label>
                    <input matInput formControlName="from" />
                  </mat-form-field>
                }
                @if (definitionHasField(selectedActivityDefinition(), 'to')) {
                  <mat-form-field appearance="outline" class="planning-attribute-grid__item">
                    <mat-label>Nach</mat-label>
                    <input matInput formControlName="to" />
                  </mat-form-field>
                }
              </div>

              <div class="planning-time-toolbar">
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  aria-label="An vorherige Aktivität andocken"
                  (click)="snapFormToPrevious()"
                >
                  <mat-icon fontIcon="chevron_left"></mat-icon>
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  (click)="shiftFormBy(-30)"
                >
                  -30
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  (click)="shiftFormBy(-5)"
                >
                  -5
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn planning-time-toolbar__btn--gap"
                  (click)="fillGapForForm()"
                >
                  Lücke
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  (click)="shiftFormBy(5)"
                >
                  +5
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  (click)="shiftFormBy(10)"
                >
                  +10
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  (click)="snapFormToNext()"
                >
                  <mat-icon fontIcon="chevron_right"></mat-icon>
                </button>
              </div>
            </div>
          </section>

          <section class="planning-section planning-section--details planning-side-panels__full">
            <header class="planning-section__header planning-section__header--clickable" (click)="toggleActivityDetails()">
              <div class="planning-section__title">Details</div>
              <div class="planning-section__subtitle">
                Von/Nach und Bemerkung.
              </div>
              <button
                type="button"
                class="planning-section__toggle"
                [attr.aria-expanded]="activityDetailsOpen()"
              >
                <mat-icon
                  class="planning-section__toggle-icon"
                  [fontIcon]="activityDetailsOpen() ? 'expand_less' : 'expand_more'"
                ></mat-icon>
              </button>
            </header>
            <div
              class="planning-section__body"
              [class.is-collapsed]="!activityDetailsOpen()"
            >
              @if (definitionHasField(selectedActivityDefinition(), 'remark')) {
                <mat-form-field appearance="outline" class="planning-type-editor__remark">
                  <mat-label>Bemerkung</mat-label>
                  <textarea matInput rows="2" formControlName="remark"></textarea>
                </mat-form-field>
              }

            </div>
          </section>
          <div class="planning-panel__actions planning-side-panels__full">
            @if (isSelectedActivityPending()) {
              <button mat-button type="button" (click)="resetPendingActivityEdits()">
                Rückgängig
              </button>
            }
            <button mat-button type="button" (click)="clearSelectedActivity()">
              {{ isSelectedActivityPending() ? 'Panel schließen' : 'Abbrechen' }}
            </button>
            <button mat-button color="warn" type="button" (click)="deleteSelectedActivity()">
              Löschen
            </button>
            <button
              mat-flat-button
              color="primary"
              type="submit"
              [disabled]="activityForm.invalid || (!isSelectedActivityPending() && activityForm.pristine)"
            >
              {{ isSelectedActivityPending() ? 'Anlegen' : 'Speichern' }}
            </button>
          </div>
        </form>

        @if (isTypePickerOpen()) {
          <div class="planning-type-overlay">
            <div class="planning-type-overlay__backdrop" (click)="closeTypePicker()"></div>
            <section class="planning-type-overlay__panel">
              <header class="planning-type-overlay__header">
                <div>
                  <div class="planning-type-overlay__title">Aktivitätstyp wählen</div>
                  <div class="planning-type-overlay__subtitle">
                    Für {{ selected.resource.name }}
                  </div>
                </div>
                <button
                  mat-icon-button
                  type="button"
                  aria-label="Typauswahl schließen"
                  (click)="closeTypePicker()"
                >
                  <mat-icon fontIcon="close"></mat-icon>
                </button>
              </header>
              <div class="planning-type-overlay__content">
                <ng-template [ngTemplateOutlet]="typePickerContent"></ng-template>
              </div>
            </section>
          </div>
        }

        <ng-template #typePickerContent>
          @if (activeTypePickerGroup(); as activeGroup) {
            <div class="planning-type-picker">
              <div class="planning-type-picker__header">
                <span class="planning-type-picker__title">Typ</span>
                <span class="planning-type-picker__current">
                  {{ selectedCatalogOption()?.label ?? 'Bitte wählen' }}
                </span>
              </div>
              @if (activityTypePickerGroups().length > 1) {
                <div class="planning-type-picker__tabs">
                  @for (group of activityTypePickerGroups(); track group.id) {
                    <button
                      type="button"
                      class="planning-type-picker__tab"
                      [class.is-active]="group.id === activeGroup.id"
                      (click)="setActivityTypePickerGroup(group.id)"
                    >
                      <mat-icon [fontIcon]="group.icon"></mat-icon>
                      <span>{{ group.label }}</span>
                      <small>{{ group.items.length }}</small>
                    </button>
                  }
                </div>
              }
              <div class="planning-type-picker__list" role="listbox" aria-label="Aktivitätstyp auswählen">
                @for (option of activeGroup.items; track option.id) {
                  <button
                    type="button"
                    class="planning-type-picker__list-item"
                    [class.is-selected]="isActivityOptionSelected(option.id)"
                    (click)="selectActivityTypeFromPicker(option.id)"
                  >
                    <span class="planning-type-picker__option-title">{{ option.label }}</span>
                    <span class="planning-type-picker__option-description">
                      {{ option.description ?? 'Ohne Beschreibung' }}
                    </span>
                  </button>
                }
              </div>
            </div>
          } @else {
            <ng-template [ngTemplateOutlet]="fallbackTypeSelect"></ng-template>
          }
        </ng-template>

        <ng-template #fallbackTypeSelect>
          <mat-form-field appearance="outline" class="planning-type-editor__fallback">
            <mat-label>Typ</mat-label>
            <mat-select [value]="activityCreationTool()" (valueChange)="selectCatalogActivity($event)">
              @for (option of activityCreationOptions(); track option.id) {
                <mat-option [value]="option.id">
                  {{ option.label }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </ng-template>
      </div>
    </div>
    }
  </section>

</section>
