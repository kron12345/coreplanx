<mat-drawer-container class="planning-drawer" [hasBackdrop]="false">
  <mat-drawer
    class="planning-solver-drawer"
    position="end"
    mode="over"
    [opened]="solverDrawerOpen()"
    (closedStart)="closeSolverDrawer()"
  >
    <div class="planning-solver-drawer__header">
      <div>
        <div class="planning-solver-drawer__title">Solver-Preview</div>
        <div class="planning-solver-drawer__subtitle">
          @if (solverPreviewState(); as preview) {
            Auswahl-Solver
          } @else {
            Keine Preview
          }
        </div>
      </div>
      <button mat-icon-button type="button" (click)="closeSolverDrawer()" aria-label="Preview schließen">
        <mat-icon fontIcon="close"></mat-icon>
      </button>
    </div>
    <div class="planning-solver-drawer__body">
      @if (solverPreviewState(); as preview) {
        <div class="planning-solver-drawer__summary">
          {{ preview.payload.summary || 'Preview bereit.' }}
        </div>
        <div class="planning-solver__preview-meta">
          <span>{{ preview.payload.upserts.length }} Einfügungen</span>
          <span>{{ preview.payload.deletedIds.length }} Löschungen</span>
          <span>{{ preview.payload.candidatesUsed.length }} Kandidaten</span>
        </div>
        @if (preview.window) {
          <div class="planning-solver__preview-window">
            Zeitfenster:
            {{ formatSolverTimestamp(preview.window.start) }} –
            {{ formatSolverTimestamp(preview.window.end) }}
          </div>
        }
        @if (preview.payload.upserts.length === 0 && preview.payload.deletedIds.length === 0) {
          <div class="planning-solver__preview-window">Keine Änderungen gefunden.</div>
        }
        <div class="planning-panel__actions">
          <button mat-stroked-button type="button" (click)="discardSolverPreview()">Verwerfen</button>
          <button
            mat-flat-button
            color="primary"
            type="button"
            (click)="applySolverPreview()"
            [disabled]="preview.payload.upserts.length === 0 && preview.payload.deletedIds.length === 0"
          >
            Übernehmen
          </button>
        </div>
      } @else {
        <div class="planning-solver-drawer__empty">Keine Preview aktiv.</div>
      }
    </div>
  </mat-drawer>
  <mat-drawer
    class="planning-debug-drawer"
    position="start"
    mode="over"
    [opened]="debugDrawerOpen()"
    (closedStart)="closeDebugDrawer()"
  >
    <div class="planning-debug-drawer__header">
      <div>
        <div class="planning-debug-drawer__title">Status & Logs</div>
        <div class="planning-debug-drawer__subtitle">
          UI <-> Backend · {{ activeStageMeta().shortLabel }}
        </div>
      </div>
      <button mat-icon-button type="button" (click)="closeDebugDrawer()" aria-label="Status schließen">
        <mat-icon fontIcon="close"></mat-icon>
      </button>
    </div>
    <div class="planning-debug-drawer__body">
      <div class="planning-debug__status-grid">
        @if (debugApiStatus(); as apiStatus) {
          <div class="planning-debug__status-card">
            <div class="planning-debug__status-label">API</div>
            <div
              class="planning-debug__status-value"
              [class.is-ok]="apiStatus.state === 'ok'"
              [class.is-error]="apiStatus.state === 'error'"
              [class.is-warn]="apiStatus.state === 'idle'"
            >
              {{ formatApiStatusLabel(apiStatus) }}
            </div>
            <div class="planning-debug__status-meta">
              Letzter Erfolg: {{ formatDebugTimestamp(apiStatus.lastSuccessAt) }}
            </div>
            @if (apiStatus.lastErrorAt) {
              <div class="planning-debug__status-meta planning-debug__status-meta--error">
                Letzter Fehler: {{ formatDebugTimestamp(apiStatus.lastErrorAt) }}
              </div>
            }
            @if (apiStatus.state === 'error' && apiStatus.message) {
              <div class="planning-debug__status-meta planning-debug__status-meta--error">
                {{ apiStatus.message }}
              </div>
            }
          </div>
        }
        @if (debugSseStatus(); as sseStatus) {
          <div class="planning-debug__status-card">
            <div class="planning-debug__status-label">SSE Basis</div>
            <div
              class="planning-debug__status-value"
              [class.is-ok]="sseStatus.base.state === 'connected'"
              [class.is-error]="sseStatus.base.state === 'error'"
              [class.is-warn]="sseStatus.base.state === 'idle'"
            >
              {{ formatSseStatusLabel(sseStatus.base) }}
            </div>
            <div class="planning-debug__status-meta">
              Letztes Event: {{ formatDebugTimestamp(sseStatus.base.lastEventAt) }}
            </div>
            @if (sseStatus.base.lastErrorAt) {
              <div class="planning-debug__status-meta planning-debug__status-meta--error">
                Letzter Fehler: {{ formatDebugTimestamp(sseStatus.base.lastErrorAt) }}
              </div>
            }
          </div>
          <div class="planning-debug__status-card">
            <div class="planning-debug__status-label">SSE Betrieb</div>
            <div
              class="planning-debug__status-value"
              [class.is-ok]="sseStatus.operations.state === 'connected'"
              [class.is-error]="sseStatus.operations.state === 'error'"
              [class.is-warn]="sseStatus.operations.state === 'idle'"
            >
              {{ formatSseStatusLabel(sseStatus.operations) }}
            </div>
            <div class="planning-debug__status-meta">
              Letztes Event: {{ formatDebugTimestamp(sseStatus.operations.lastEventAt) }}
            </div>
            @if (sseStatus.operations.lastErrorAt) {
              <div class="planning-debug__status-meta planning-debug__status-meta--error">
                Letzter Fehler: {{ formatDebugTimestamp(sseStatus.operations.lastErrorAt) }}
              </div>
            }
          </div>
        }
        @if (debugBackendStreamStatus(); as backendStatus) {
          <div class="planning-debug__status-card">
            <div class="planning-debug__status-label">Backend-Stream</div>
            <div
              class="planning-debug__status-value"
              [class.is-ok]="backendStatus.state === 'connected'"
              [class.is-error]="backendStatus.state === 'error'"
              [class.is-warn]="backendStatus.state === 'idle'"
            >
              {{ formatSseStatusLabel(backendStatus) }}
            </div>
            <div class="planning-debug__status-meta">
              Letztes Event: {{ formatDebugTimestamp(backendStatus.lastEventAt) }}
            </div>
            @if (backendStatus.lastErrorAt) {
              <div class="planning-debug__status-meta planning-debug__status-meta--error">
                Letzter Fehler: {{ formatDebugTimestamp(backendStatus.lastErrorAt) }}
              </div>
            }
            @if (backendStatus.state === 'error' && backendStatus.message) {
              <div class="planning-debug__status-meta planning-debug__status-meta--error">
                {{ backendStatus.message }}
              </div>
            }
          </div>
        }
        @if (debugViewportStatus(); as viewportMap) {
          @if (viewportMap[activeStageId()]; as viewport) {
            <div class="planning-debug__status-card">
              <div class="planning-debug__status-label">Viewport {{ activeStageMeta().shortLabel }}</div>
              <div class="planning-debug__status-value">
                {{ viewport.resourceCount }} Ressourcen
              </div>
              <div class="planning-debug__status-meta">
                Zeitraum:
                {{ formatDebugTimestamp(viewport.windowStart) }} –
                {{ formatDebugTimestamp(viewport.windowEnd) }}
              </div>
              <div class="planning-debug__status-meta">
                Letzter Load: {{ formatDebugTimestamp(viewport.lastLoadAt) }}
              </div>
              @if (viewport.lastActivityCount !== undefined) {
                <div class="planning-debug__status-meta">
                  Aktivitaeten: {{ viewport.lastActivityCount }}
                </div>
              }
              @if (viewport.lastErrorAt) {
                <div class="planning-debug__status-meta planning-debug__status-meta--error">
                  Letzter Fehler: {{ formatDebugTimestamp(viewport.lastErrorAt) }}
                </div>
              }
            </div>
          }
        }
      </div>

      <div class="planning-debug__controls">
        <mat-slide-toggle
          [checked]="debugBackendStreamEnabled()"
          (change)="setDebugBackendStreamEnabled($event.checked)"
        >
          Backend-Stream
        </mat-slide-toggle>
        <mat-slide-toggle
          [checked]="debugPaused()"
          (change)="setDebugPaused($event.checked)"
        >
          Logs pausieren
        </mat-slide-toggle>
        <mat-slide-toggle
          [checked]="debugShowAll()"
          (change)="setDebugShowAll($event.checked)"
        >
          Alle Logs
        </mat-slide-toggle>
        <button mat-button type="button" (click)="clearDebugLogs()">Leeren</button>
        <button mat-stroked-button type="button" (click)="toggleDebugExport()">JSON Export</button>
      </div>

      <div class="planning-debug__token-row">
        <mat-form-field appearance="outline" class="planning-debug__token-field">
          <mat-label>Stream-Token (optional)</mat-label>
          <input
            matInput
            type="password"
            autocomplete="off"
            [value]="debugStreamToken()"
            (input)="setDebugStreamToken($any($event.target).value)"
          />
        </mat-form-field>
        @if (debugPaused()) {
          <div class="planning-debug__paused-meta">
            Pausiert: {{ debugPendingCount() }} neue Eintraege
          </div>
        }
      </div>

      <div class="planning-debug__filters">
        <div class="planning-debug__filter-row">
          <mat-form-field appearance="outline" class="planning-debug__filter-field">
            <mat-label>Suche</mat-label>
            <input
              matInput
              autocomplete="off"
              [value]="debugFilterQuery()"
              (input)="setDebugFilterQuery($any($event.target).value)"
            />
          </mat-form-field>
          <button mat-stroked-button type="button" (click)="clearDebugFilters()">Filter leeren</button>
        </div>
        <div class="planning-debug__filter-row">
          <span class="planning-debug__filter-label">Scope</span>
          @for (scope of debugScopeOptions; track scope) {
            <button
              type="button"
              class="planning-debug__filter-chip"
              [class.is-active]="debugScopeFilters().includes(scope)"
              (click)="toggleDebugScopeFilter(scope)"
            >
              {{ scope }}
            </button>
          }
        </div>
        <div class="planning-debug__filter-row">
          <span class="planning-debug__filter-label">Quelle</span>
          @for (source of debugSourceOptions; track source) {
            <button
              type="button"
              class="planning-debug__filter-chip"
              [class.is-active]="debugSourceFilters().includes(source)"
              (click)="toggleDebugSourceFilter(source)"
            >
              {{ source }}
            </button>
          }
        </div>
        <div class="planning-debug__filter-row">
          <span class="planning-debug__filter-label">Topic</span>
          @for (topic of debugTopicOptions; track topic) {
            <button
              type="button"
              class="planning-debug__filter-chip"
              [class.is-active]="debugTopicFilters().includes(topic)"
              (click)="toggleDebugTopicFilter(topic)"
            >
              {{ topic }}
            </button>
          }
        </div>
      </div>

      @if (debugExportOpen()) {
        <div class="planning-debug__export">
          <div class="planning-debug__export-actions">
            <button mat-stroked-button type="button" (click)="copyDebugExport()">Kopieren</button>
          </div>
          <textarea class="planning-debug__export-text" rows="12" readonly>{{ debugExportJson() }}</textarea>
        </div>
      } @else {
        <div class="planning-debug__logs">
          @if (debugLogEntries().length === 0) {
            <div class="planning-debug__empty">Keine Logeintraege.</div>
          } @else {
            @for (entry of debugLogEntries(); track entry.id) {
              <div
                class="planning-debug__log-entry"
                [class.is-warn]="entry.level === 'warn'"
                [class.is-error]="entry.level === 'error'"
              >
                <div class="planning-debug__log-meta">
                  <span>{{ formatDebugTimestamp(entry.timestamp) }}</span>
                  <span class="planning-debug__log-tag">{{ entry.level }}</span>
                  @if (entry.source) {
                    <span class="planning-debug__log-tag">{{ entry.source }}</span>
                  }
                  <span class="planning-debug__log-tag">{{ entry.scope }}</span>
                  @if (entry.topic) {
                    <span class="planning-debug__log-tag">{{ entry.topic }}</span>
                  }
                  @if (entry.stageId) {
                    <span class="planning-debug__log-tag">{{ entry.stageId }}</span>
                  }
                </div>
                <div class="planning-debug__log-message">{{ entry.message }}</div>
                @if (formatDebugContext(entry.context); as contextText) {
                  <pre class="planning-debug__log-context">{{ contextText }}</pre>
                }
              </div>
            }
          }
        </div>
      }
    </div>
  </mat-drawer>
  <mat-drawer-content>
    <section class="planning-dashboard">
  <header class="planning-toolbar">
    <div class="planning-toolbar__bar">
        <div class="planning-toolbar__summary-block">
          <button
            type="button"
            class="planning-toolbar__status"
            (click)="toggleDebugDrawer()"
            [class.is-open]="debugDrawerOpen()"
            [class.is-ok]="debugConnectionState() === 'ok'"
            [class.is-warn]="debugConnectionState() === 'warn'"
            [class.is-error]="debugConnectionState() === 'error'"
            matTooltip="Status & Logs"
            aria-label="Statuspanel öffnen"
          >
            <mat-icon fontIcon="sensors"></mat-icon>
            <span>Backend</span>
            <span class="planning-toolbar__status-label">{{ debugConnectionLabel() }}</span>
            @if (debugAlertCount() > 0) {
              <span class="planning-toolbar__status-count">{{ debugAlertCount() }}</span>
            }
          </button>
        <span class="planning-toolbar__summary">
          {{ boards().length }} Plantafel(n) · {{ resources().length }} Ressourcen ·
          {{ selectionSize() }} ausgewählt · {{ selectedSimulationLabel() }}
        </span>
        @if (activeStageId() === 'base') {
          <button
            mat-stroked-button
            color="primary"
            class="planning-toolbar__base-toggle"
            (click)="openPeriodsWindow()"
            matTooltip="Zeiträume und Spezialtage in neuem Fenster bearbeiten."
          >
            <mat-icon fontIcon="view_week"></mat-icon>
            Zeiträume bearbeiten
          </button>
        }
        @if (activeStageId() === 'base' && planningVariant()?.type === 'simulation') {
          <button
            mat-flat-button
            color="primary"
            class="planning-toolbar__base-toggle"
            (click)="publishBasePlanningToProductive()"
            [disabled]="!canPublishBasePlanning()"
            matTooltip="Übernimmt diese Basisplanung als neue produktive Basis (alte Basis wird archiviert)."
          >
            <mat-icon fontIcon="published_with_changes"></mat-icon>
            Als Produktiv veröffentlichen
          </button>
        }
        @if (activeStageId() === 'operations' && planningVariant()?.type === 'productive') {
          <button
            mat-flat-button
            color="primary"
            class="planning-toolbar__base-toggle"
            (click)="snapshotOperationsFromBase()"
            [disabled]="!canSnapshotOperationsFromBase()"
            matTooltip="Erstellt (oder überschreibt) die Betriebsplanung als Snapshot aus der produktiven Basis."
          >
            <mat-icon fontIcon="move_down"></mat-icon>
            Snapshot aus Basis
          </button>
        }
      </div>

      <div class="planning-filter-bar">
        <div class="planning-filter" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="layers"></mat-icon>
            <span>{{ activeStageMeta().label }}</span>
          </button>
          <div class="planning-filter__panel">
            <div class="planning-filter__panel-title">Planungsphase</div>
            <div class="planning-filter__panel-list">
              @for (stage of stages; track stage.id) {
                <button
                  type="button"
                  class="planning-filter__option"
                  [class.is-active]="stage.id === activeStageId()"
                  (click)="onStageChange(stage.id)"
                >
                  <strong>{{ stage.label }}</strong>
                  <span>{{ stage.description }}</span>
                </button>
              }
            </div>
          </div>
        </div>

        <div class="planning-filter planning-filter--wide" tabindex="0">
          <button #yearFilterTrigger type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="calendar_month"></mat-icon>
            <span>{{ timetableYearSummary() }}</span>
          </button>
          <div class="planning-filter__panel planning-filter__panel--wide">
            <div class="planning-filter__panel-title">Fahrplanjahre</div>
            <div class="planning-filter__panel-actions">
              <button mat-stroked-button type="button" (click)="selectDefaultTimetableYear()">
                Aktuelles
              </button>
              <button mat-button type="button" (click)="selectAllTimetableYears()">
                Alle
              </button>
            </div>
            @defer (on interaction(yearFilterTrigger); on hover(yearFilterTrigger)) {
              <div class="planning-filter__panel-list planning-filter__panel-list--resources">
                @for (year of timetableYearOptions(); track year.label) {
                  <mat-checkbox
                    [checked]="isTimetableYearSelected(year.label)"
                    (change)="onTimetableYearToggle(year.label, $event.checked)"
                  >
                    {{ year.label }} · {{ year.startIso }} – {{ year.endIso }}
                  </mat-checkbox>
                }
              </div>
            } @placeholder {
              <p class="planning-filter__empty">Fahrplanjahre werden geladen…</p>
            }
          </div>
        </div>

        <div class="planning-filter" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="science"></mat-icon>
            <span>{{ selectedSimulationLabel() }}</span>
          </button>
          <div class="planning-filter__panel">
            <div class="planning-filter__panel-title">Planungsvariante</div>
            <div class="planning-filter__panel-list">
              @if (simulationOptions().length) {
                @for (sim of simulationOptions(); track sim.id) {
                  <button
                    type="button"
                    class="planning-filter__option"
                    [class.is-active]="sim.id === selectedSimulationId()"
                    (click)="onSimulationSelect(sim.id)"
                  >
                    <strong>{{ sim.label }}</strong>
                    <span>{{ sim.productive ? 'Produktiv' : 'Simulation' }} · {{ sim.timetableYearLabel }}</span>
                  </button>
                }
              } @else {
                <p class="planning-filter__empty">Keine Varianten für die gewählten Fahrplanjahre.</p>
              }
            </div>
          </div>
        </div>

        <div class="planning-filter planning-filter--wide" tabindex="0">
          <button #resourceFilterTrigger type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="group"></mat-icon>
            <span>Ressourcen</span>
          </button>
          <div class="planning-filter__panel planning-filter__panel--wide">
            <div class="planning-filter__panel-title">Ressourcen</div>
            <div class="planning-filter__panel-actions">
              <button mat-stroked-button (click)="selectAllResources()">Alle</button>
              <button mat-button (click)="clearSelection()">Leeren</button>
            </div>
            @defer (on interaction(resourceFilterTrigger); on hover(resourceFilterTrigger)) {
              <div class="planning-filter__panel-groups">
                @for (group of resourceGroups(); track group.label) {
                  <div class="planning-filter__panel-group">
                    <header>
                      <strong>{{ group.label }}</strong>
                      <small>{{ group.resources.length }} Ressourcen</small>
                    </header>
                    <div class="planning-filter__panel-list planning-filter__panel-list--resources">
                      @for (resource of group.resources; track resource.id) {
                        <mat-checkbox
                          [checked]="isResourceSelected(resource.id)"
                          (change)="onSelectionToggle(resource.id, $event.checked)"
                        >
                          {{ resource.name }}
                        </mat-checkbox>
                      }
                    </div>
                  </div>
                }
              </div>
            } @placeholder {
              <p class="planning-filter__empty">Ressourcen werden geladen…</p>
            }
          </div>
        </div>

        <div class="planning-filter" tabindex="0">
          <button type="button" class="planning-filter__trigger">
            <mat-icon fontIcon="view_week"></mat-icon>
            <span>Leistungen</span>
          </button>
          <div class="planning-filter__panel">
            <div class="planning-filter__panel-title">Leistungstypen</div>
            <div class="planning-filter__tags">
              @for (option of activityCreationOptions(); track option.id) {
                <button type="button" (click)="selectCatalogActivity(option.id)">
                  {{ option.label }}
                </button>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="planning-toolbar__quick">
        <button
          mat-icon-button
          matTooltip="Plantafel aus Auswahl"
          (click)="createBoardFromSelection()"
        >
          <mat-icon fontIcon="library_add"></mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Auswahl hinzufügen"
          [disabled]="!hasSelection()"
          [matMenuTriggerFor]="selectionAddMenu"
        >
          <mat-icon fontIcon="playlist_add"></mat-icon>
        </button>
        <button
          mat-icon-button
          matTooltip="Plantafel ersetzen"
          [disabled]="!hasSelection()"
          [matMenuTriggerFor]="selectionReplaceMenu"
        >
          <mat-icon fontIcon="sync_alt"></mat-icon>
        </button>
      </div>
    </div>
  </header>

  <mat-menu #selectionAddMenu="matMenu">
    @for (board of boards(); track board.id) {
      <button mat-menu-item (click)="addSelectionToBoard(board.id)">
        {{ board.title }}
      </button>
    }
  </mat-menu>

  <mat-menu #selectionReplaceMenu="matMenu">
    @for (board of boards(); track board.id) {
      <button mat-menu-item (click)="replaceBoardWithSelection(board.id)">
        {{ board.title }}
      </button>
    }
  </mat-menu>

  <mat-menu #boardActionsMenu="matMenu">
    <ng-template matMenuContent let-board="board">
      <button mat-menu-item (click)="setSelectionFromBoard(board.id)">
        Auswahl übernehmen
      </button>
      <button mat-menu-item [disabled]="!hasSelection()" (click)="addSelectionToBoard(board.id)">
        Auswahl hinzufügen
      </button>
      <button mat-menu-item [disabled]="!hasSelection()" (click)="replaceBoardWithSelection(board.id)">
        Ersetzen
      </button>
    </ng-template>
  </mat-menu>

  <section class="planning-main">
    <mat-card class="planning-main__card">
      <mat-card-content>
        <mat-tab-group
          class="planning-board-tabs"
          [selectedIndex]="selectedBoardIndex()"
          (selectedIndexChange)="handleBoardIndexChange($event)"
          animationDuration="250ms"
          [preserveContent]="true"
        >
          @for (board of boards(); track board.id) {
            <mat-tab>
              <ng-template mat-tab-label>
                <span [class.is-active]="isActiveBoard(board.id)">{{ board.title }}</span>
                <span class="planning-tab-actions">
                  <app-gantt-window-launcher
                    [stageId]="activeStageId()"
                    [boardId]="board.id"
                    [resourceIds]="board.resourceIds"
                    [variantId]="planningVariant()?.id ?? null"
                    [timetableYearLabel]="planningVariant()?.timetableYearLabel ?? null"
                  />
                  @if (boards().length > 1) {
                    <button
                      mat-icon-button
                      matTooltip="Plantafel schließen"
                      (click)="removeBoard(board.id); $event.stopPropagation()"
                    >
                      <mat-icon fontIcon="close"></mat-icon>
                    </button>
                  }
                </span>
              </ng-template>

              <ng-template matTabContent>
                @if (activeStageLoading()) {
                  <mat-progress-bar class="planning-tab-loader" mode="indeterminate"></mat-progress-bar>
                }
                <div class="planning-board">
                  @if (board.resourceIds.length > 0) {
                    <div class="planning-board__gantt">
                      <app-gantt
                        [resources]="boardResources(board)"
                        [activities]="boardActivities(board)"
                        [previewActivities]="solverPreviewActivities()"
                        [pendingActivity]="boardPendingActivity(board)"
                        [syncingActivityIds]="activeSyncingActivityIds()"
                        [timelineRange]="timelineRange()"
                        [periods]="currentPeriods()"
                        [minTimelineDays]="activeStageId() === 'base' ? 8 : 30"
                        [snapTimelineToMidnight]="activeStageId() !== 'base'"
                        [resourceViewModes]="resourceViewModes()"
                        [selectedActivityIds]="selectedActivityIdsArray()"
                        [activityTypeInfo]="activityTypeInfoMap()"
                        (viewportChanged)="handleViewportChange(board, $event)"
                        (resourceViewModeChange)="handleResourceViewModeChange($event)"
                        (serviceAssignmentRequested)="handleServiceAssignRequest($event)"
                        (activityCreateRequested)="handleActivityCreate($event)"
                        (activityEditRequested)="handleActivityEdit($event)"
                        (activityCopyRequested)="handleActivityCopy($event)"
                        (activityRepositionRequested)="handleActivityReposition($event)"
                        (activitySelectionToggle)="handleActivitySelectionToggle($event)"
                        (removeResource)="removeResourceFromBoard(board.id, $event)"
                      >
                        <ng-container gantt-menu-actions>
                          <button
                            mat-icon-button
                            class="planning-board__menu-trigger"
                            [matMenuTriggerFor]="boardActionsMenu"
                            [matMenuTriggerData]="{ board: board }"
                            matTooltip="Aktionen"
                          >
                            <mat-icon fontIcon="more_vert"></mat-icon>
                          </button>
                        </ng-container>
                      </app-gantt>
                    </div>
                  } @else {
                    <div class="planning-board__empty">
                      <mat-icon fontIcon="dashboard"></mat-icon>
                      <p>Diese Plantafel enthält noch keine Ressourcen. Bitte Auswahl hinzufügen.</p>
                    </div>
                  }
                </div>
              </ng-template>
            </mat-tab>
          }
        </mat-tab-group>
      </mat-card-content>
    </mat-card>
  </section>

  <section class="planning-side-panels">
    @if (pendingServiceResource(); as pending) {
      <mat-card>
        <mat-card-header>
          <mat-card-title>Dienst zuweisen</mat-card-title>
          <mat-card-subtitle>{{ pending.name }}</mat-card-subtitle>
        </mat-card-header>
        <mat-card-content>
          <p>Wähle eine Ressource aus, die diesen Dienst übernehmen soll.</p>
          <mat-form-field appearance="outline" class="planning-side-panels__field">
            <mat-label>Zielressource</mat-label>
            <mat-select
              [value]="serviceAssignmentTarget()"
              (selectionChange)="setServiceAssignmentTarget($event.value)"
            >
              @for (candidate of assignmentCandidates(); track candidate.id) {
                <mat-option [value]="candidate.id">
                  {{ candidate.name }}
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        </mat-card-content>
        <mat-card-actions align="end">
          <button mat-button type="button" (click)="cancelServiceAssignment()">Abbrechen</button>
          <button
            mat-flat-button
            color="primary"
            type="button"
            [disabled]="!serviceAssignmentTarget()"
            (click)="confirmServiceAssignment()"
          >
            Zuweisen
          </button>
        </mat-card-actions>
      </mat-card>
    }

    @if (selectedActivities().length > 0) {
      <div class="planning-panel" cdkDrag>
        <div class="planning-panel__header" cdkDragHandle>
          <div>
            <div class="planning-panel__title">Auswahl</div>
            <div class="planning-panel__subtitle">{{ selectedActivities().length }} Aktivität(en)</div>
          </div>
          <button mat-icon-button type="button" (click)="clearActivitySelection()" aria-label="Auswahl leeren">
            <mat-icon fontIcon="close"></mat-icon>
          </button>
        </div>
        <div class="planning-panel__body">
          <mat-expansion-panel
            class="planning-selection-details"
            [expanded]="selectionDetailsOpen()"
            (opened)="setSelectionDetailsOpen(true)"
            (closed)="setSelectionDetailsOpen(false)"
          >
            <mat-expansion-panel-header>
              <mat-panel-title>Leistungsdetails</mat-panel-title>
              <mat-panel-description>
                {{ selectedActivities().length }} Eintraege
              </mat-panel-description>
            </mat-expansion-panel-header>
            <div class="planning-selection-table">
              <div class="planning-selection-table__header">
                <span>Ressource</span>
                <span>Dienst</span>
                <span>Typ</span>
                <span>Start</span>
                <span>Ende</span>
                <span>Von</span>
                <span>Nach</span>
              </div>
              @for (row of selectedActivityDetails(); track row.id) {
                <div class="planning-selection-table__row">
                  <span>{{ row.resource }}</span>
                  <span>{{ row.service }}</span>
                  <span>{{ row.type }}</span>
                  <span>{{ row.start }}</span>
                  <span>{{ row.end }}</span>
                  <span>{{ row.from }}</span>
                  <span>{{ row.to }}</span>
                </div>
              }
            </div>
          </mat-expansion-panel>

          <div class="planning-solver-section">
            <div class="planning-solver-section__header">
              <div>
                <div class="planning-solver-section__title">Solver (Auswahl)</div>
                <div class="planning-solver-section__subtitle">
                  Nutzt markierte Leistungen und ausgewaehlte Ressourcen.
                </div>
              </div>
            </div>
            @if (solverResourceOptions().length > 0) {
              <mat-form-field appearance="outline" class="planning-solver-section__field">
                <mat-label>Ressourcen</mat-label>
                <mat-select
                  multiple
                  [value]="solverResourceSelection()"
                  (selectionChange)="setSolverResourceSelection($event.value)"
                >
                  @for (resource of solverResourceOptions(); track resource.id) {
                    <mat-option [value]="resource.id">
                      {{ resource.name }}
                    </mat-option>
                  }
                </mat-select>
                <mat-hint>{{ solverResourceSelectionLabel() }}</mat-hint>
              </mat-form-field>
            }
            <div class="planning-solver-section__meta">
              <span>{{ solverActivityIds().length }} Aktivitaet(en) im Solver</span>
            </div>
            <div class="planning-solver-section__actions">
              <button
                mat-stroked-button
                type="button"
                (click)="openOptimizerCandidates()"
                [disabled]="optimizerLoading().candidates || solverActivityIds().length === 0"
              >
                Kandidaten
              </button>
              <button
                mat-flat-button
                color="primary"
                type="button"
                (click)="openOptimizerSolve()"
                [disabled]="optimizerLoading().solve || solverActivityIds().length === 0"
              >
                Preview
              </button>
              <button
                mat-stroked-button
                type="button"
                (click)="openSolverDrawer()"
                [disabled]="!solverPreviewState()"
              >
                Preview oeffnen
              </button>
            </div>
            @if (solverPreviewState(); as preview) {
              <div class="planning-solver-section__preview-hint">
                Preview bereit: {{ preview.payload.upserts.length }} Einfuegungen ·
                {{ preview.payload.deletedIds.length }} Loeschungen
              </div>
            }
          </div>

          <div class="planning-side-panels__shift">
            <span>Gruppierung</span>
            <button mat-stroked-button type="button" (click)="createGroupFromSelection()">
              Neue Gruppe
            </button>
            <button
              mat-stroked-button
              type="button"
              (click)="editSelectedGroup()"
              [disabled]="!selectedGroupSummary()"
            >
              Gruppe bearbeiten
            </button>
            <button
              mat-stroked-button
              type="button"
              (click)="addSelectionToFocusedGroup()"
              [disabled]="!canAddSelectionToFocusedGroup()"
            >
              Zur Fokus-Gruppe
            </button>
            <button
              mat-stroked-button
              color="warn"
              type="button"
              (click)="removeSelectionFromGroup()"
              [disabled]="!selectionHasGroup()"
            >
              Aus Gruppe entfernen
            </button>
          </div>

          <div class="planning-side-panels__buttons">
            <button mat-stroked-button type="button" (click)="clearActivitySelection()">
              Auswahl leeren
            </button>
            <button
              mat-stroked-button
              color="warn"
              type="button"
              (click)="deleteActivitySelection()"
              [disabled]="selectedActivities().length === 0"
            >
              Auswahl löschen
            </button>
          </div>
        </div>
      </div>
    }
    @if (selectedActivity(); as selected) {
      <div class="planning-panel planning-panel--form" cdkDrag>
      <div class="planning-panel__header" cdkDragHandle>
        <div>
          <div class="planning-panel__title">
            {{ isSelectedActivityPending() ? 'Aktivität anlegen' : 'Aktivität bearbeiten' }}
          </div>
          <div class="planning-panel__subtitle">
            {{ activityTypeLabel(selected.activity.type) }}
            @if (isSelectedActivityPending()) {
              <span class="planning-panel__badge">Entwurf</span>
            }
          </div>
        </div>
        <button mat-icon-button type="button" (click)="clearSelectedActivity()" aria-label="Panel schließen">
          <mat-icon fontIcon="close"></mat-icon>
        </button>
      </div>
      <div class="planning-panel__body">
        <form [formGroup]="activityForm" class="planning-side-panels__form" (ngSubmit)="saveSelectedActivityEdits()">
          <input type="hidden" formControlName="type" />

	          <div class="planning-type-summary planning-side-panels__full">
	            <div class="planning-type-summary__row">
	              <span class="planning-type-summary__chip">
	                <span
	                  class="planning-type-summary__swatch"
	                  [style.background]="activityTypeOptionColor(selectedCatalogOption())"
	                ></span>
	                {{ selectedCatalogOption()?.label ?? selectedActivityDefinition()?.label ?? 'Aktivitätstyp wählen' }}
	              </span>
	              <div class="planning-type-summary__actions">
	                <mat-button-toggle-group
	                  class="planning-type-summary__mode"
	                  [value]="activityDetailsOpen() ? 'advanced' : 'basic'"
	                  (valueChange)="setActivityEditorMode($event)"
	                  aria-label="Editor-Modus"
	                >
	                  <mat-button-toggle value="basic">Basic</mat-button-toggle>
	                  <mat-button-toggle value="advanced">Erweitert</mat-button-toggle>
	                </mat-button-toggle-group>
	                <button
	                  #typeMenuTrigger="matMenuTrigger"
	                  type="button"
	                  class="planning-type-summary__change"
	                  [matMenuTriggerFor]="activityTypeMenu"
	                  (menuOpened)="onActivityTypeMenuOpened()"
	                >
	                  Typ wählen…
	                </button>
	              </div>
	            </div>
	          </div>

	          <mat-menu #activityTypeMenu="matMenu" class="planning-type-menu" xPosition="after" yPosition="below">
	            <div
	              class="planning-type-menu__search"
	              (click)="$event.stopPropagation()"
	              (keydown)="$event.stopPropagation()"
	            >
	              <mat-form-field appearance="outline" class="planning-type-menu__search-field">
	                <mat-label>Suchen</mat-label>
	                <mat-icon matPrefix fontIcon="search"></mat-icon>
	                <input
	                  #typeSearchInput
	                  matInput
	                  autocomplete="off"
	                  [value]="activityTypeSearchQuery()"
	                  (input)="setActivityTypeSearchQuery($any($event.target).value)"
	                />
	                @if (activityTypeSearchQuery().trim().length) {
	                  <button
	                    mat-icon-button
	                    matSuffix
	                    type="button"
	                    aria-label="Suche löschen"
	                    (click)="$event.stopPropagation(); setActivityTypeSearchQuery('')"
	                  >
	                    <mat-icon fontIcon="close"></mat-icon>
	                  </button>
	                }
	              </mat-form-field>
	            </div>
	            <mat-divider></mat-divider>

	            @for (group of filteredActivityTypePickerGroups(); track group.id) {
	              <button mat-menu-item type="button" disabled class="planning-type-menu__header">
	                <mat-icon [fontIcon]="group.icon"></mat-icon>
	                <span>{{ group.label }}</span>
	              </button>
	              @for (option of group.items; track option.id) {
	                <button mat-menu-item type="button" (click)="selectCatalogActivity(option.id)">
	                  <span class="planning-type-menu__item">
	                    <span
	                      class="planning-type-menu__swatch"
	                      [style.background]="activityTypeOptionColor(option)"
	                    ></span>
	                    <span class="planning-type-menu__text">
	                      <span class="planning-type-menu__label">{{ option.label }}</span>
	                      <span class="planning-type-menu__description">
	                        {{ option.description ?? '' }}
	                      </span>
	                    </span>
	                  </span>
	                </button>
	              }
	              <mat-divider></mat-divider>
	            }
	          </mat-menu>

	          @if (isSelectedActivityPending() && quickActivityTypes().length > 0) {
	            <section class="planning-type-quick planning-side-panels__full">
	              <div class="planning-type-quick__label">
	                Typ-Schnellauswahl
	              </div>
	              <div class="planning-type-quick__chips">
	                @for (option of quickActivityTypes(); track option.id) {
	                  <button
	                    type="button"
	                    class="planning-type-quick__chip"
	                    [class.is-selected]="isActivityOptionSelected(option.id)"
	                    (click)="selectCatalogActivity(option.id)"
	                  >
	                    <span
	                      class="planning-type-quick__swatch"
	                      [style.background]="activityTypeOptionColor(option)"
	                    ></span>
	                    <span class="planning-type-quick__chip-label">
	                      {{ option.label }}
	                    </span>
	                  </button>
	                }
	                <button
	                  type="button"
	                  class="planning-type-quick__chip planning-type-quick__chip--all"
	                  [matMenuTriggerFor]="activityTypeMenu"
	                  (menuOpened)="onActivityTypeMenuOpened()"
	                >
	                  Alle Typen…
	                </button>
	              </div>
	            </section>
	          }

          @if (isSelectedActivityPending()) {
            <div class="planning-banner planning-banner--draft planning-side-panels__full">
              <mat-icon fontIcon="edit_note"></mat-icon>
              <div>
                <div class="planning-banner__title">Entwurf</div>
                <div class="planning-banner__text">
                  Noch nicht gespeichert. Nach dem Speichern berechnet das Backend Dienst und Konflikte neu.
                </div>
              </div>
            </div>
          } @else if (activityForm.dirty) {
            <div class="planning-banner planning-banner--dirty planning-side-panels__full">
              <mat-icon fontIcon="warning"></mat-icon>
              <div>
                <div class="planning-banner__title">Ungespeicherte Änderungen</div>
                <div class="planning-banner__text">Speichern oder mit „Abbrechen“ verwerfen.</div>
              </div>
            </div>
          }

	          <section class="planning-section planning-section--time planning-side-panels__full">
            <header class="planning-section__header">
              <div class="planning-section__title">Zeit</div>
              <div class="planning-section__subtitle">
                Start, Ende, Dauer und Andocken.
              </div>
            </header>
            <div class="planning-type-editor__fields planning-type-editor__fields--full">
              <div class="planning-attribute-grid planning-attribute-grid--time">
                <mat-form-field appearance="outline" class="planning-attribute-grid__item">
                  <mat-label>Start</mat-label>
                  <input matInput type="datetime-local" formControlName="start" />
                  @if (
                    activityForm.controls.start.invalid &&
                    (activityForm.controls.start.dirty || activityForm.controls.start.touched)
                  ) {
                    <mat-error>Startzeit ist erforderlich.</mat-error>
                  }
                </mat-form-field>
                @if (shouldShowEndField(selectedActivityDefinition())) {
                  <mat-form-field appearance="outline" class="planning-attribute-grid__item">
                    <mat-label>Ende</mat-label>
                    <input
                      matInput
                      type="datetime-local"
                      formControlName="end"
                      (focus)="markTimeSyncSource('end')"
                    />
                  </mat-form-field>
                }
                @if (definitionHasField(selectedActivityDefinition(), 'from') && !isLocationFieldHidden(selectedCatalogOption(), 'from')) {
                  <mat-form-field appearance="outline" class="planning-attribute-grid__item">
                    <mat-label>Von</mat-label>
                    <input matInput formControlName="from" [matAutocomplete]="fromLocationAuto" autocomplete="off" />
                    @if (fromLocationSuggestion(); as suggestion) {
                      <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        [matTooltip]="'Wie vorher: ' + suggestion"
                        aria-label="Von wie vorher übernehmen"
                        (click)="applyFromLocationSuggestion()"
                      >
                        <mat-icon fontIcon="subdirectory_arrow_left"></mat-icon>
                      </button>
                    }
                    <mat-autocomplete #fromLocationAuto="matAutocomplete" autoActiveFirstOption>
                      <mat-optgroup label="Betriebspunkte">
                        @for (option of fromOperationalPointOptions(); track option.key) {
                          <mat-option [value]="option.value">
                            <span>{{ option.label }}</span>
                            @if (option.description) {
                              <small class="planning-location-option__hint">{{ option.description }}</small>
                            }
                          </mat-option>
                        }
                      </mat-optgroup>
                      @if (includePersonnelSitesInLocationLookup() && fromPersonnelSiteOptions().length > 0) {
                        <mat-optgroup label="Personnel Sites">
                          @for (option of fromPersonnelSiteOptions(); track option.key) {
                            <mat-option [value]="option.value">
                              <span>{{ option.label }}</span>
                              @if (option.description) {
                                <small class="planning-location-option__hint">{{ option.description }}</small>
                              }
                            </mat-option>
                          }
                        </mat-optgroup>
                      }
                    </mat-autocomplete>
                    @if (
                      activityForm.controls.from.invalid &&
                      (activityForm.controls.from.dirty || activityForm.controls.from.touched)
                    ) {
                      <mat-error>Ort ist erforderlich.</mat-error>
                    }
                  </mat-form-field>
                }
                @if (definitionHasField(selectedActivityDefinition(), 'to') && !isLocationFieldHidden(selectedCatalogOption(), 'to')) {
                  <mat-form-field appearance="outline" class="planning-attribute-grid__item">
                    <mat-label>Nach</mat-label>
                    <input matInput formControlName="to" [matAutocomplete]="toLocationAuto" autocomplete="off" />
                    @if (toLocationSuggestion(); as suggestion) {
                      <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        [matTooltip]="'Wie nachher: ' + suggestion"
                        aria-label="Nach wie nachher übernehmen"
                        (click)="applyToLocationSuggestion()"
                      >
                        <mat-icon fontIcon="subdirectory_arrow_right"></mat-icon>
                      </button>
                    }
                    <mat-autocomplete #toLocationAuto="matAutocomplete" autoActiveFirstOption>
                      <mat-optgroup label="Betriebspunkte">
                        @for (option of toOperationalPointOptions(); track option.key) {
                          <mat-option [value]="option.value">
                            <span>{{ option.label }}</span>
                            @if (option.description) {
                              <small class="planning-location-option__hint">{{ option.description }}</small>
                            }
                          </mat-option>
                        }
                      </mat-optgroup>
                      @if (includePersonnelSitesInLocationLookup() && toPersonnelSiteOptions().length > 0) {
                        <mat-optgroup label="Personnel Sites">
                          @for (option of toPersonnelSiteOptions(); track option.key) {
                            <mat-option [value]="option.value">
                              <span>{{ option.label }}</span>
                              @if (option.description) {
                                <small class="planning-location-option__hint">{{ option.description }}</small>
                              }
                            </mat-option>
                          }
                        </mat-optgroup>
                      }
                    </mat-autocomplete>
                    @if (
                      activityForm.controls.to.invalid &&
                      (activityForm.controls.to.dirty || activityForm.controls.to.touched)
                    ) {
                      <mat-error>Ort ist erforderlich.</mat-error>
                    }
                  </mat-form-field>
                }
                @if (shouldShowEndField(selectedActivityDefinition())) {
                  <mat-form-field
                    appearance="outline"
                    class="planning-attribute-grid__item planning-attribute-grid__item--span-2"
                  >
                    <mat-label>Dauer</mat-label>
                    <input
                      matInput
                      type="number"
                      min="1"
                      step="5"
                      formControlName="durationMinutes"
                      (focus)="markTimeSyncSource('duration')"
                    />
                    <span matTextSuffix>min</span>
                  </mat-form-field>
                }
              </div>

              <div class="planning-time-toolbar">
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  aria-label="An vorherige Aktivität andocken"
                  (click)="snapFormToPrevious()"
                >
                  <mat-icon fontIcon="chevron_left"></mat-icon>
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  (click)="shiftFormBy(-30)"
                >
                  -30
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  (click)="shiftFormBy(-5)"
                >
                  -5
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn planning-time-toolbar__btn--gap"
                  (click)="fillGapForForm()"
                >
                  Lücke
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  (click)="shiftFormBy(5)"
                >
                  +5
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  (click)="shiftFormBy(10)"
                >
                  +10
                </button>
                <button
                  mat-stroked-button
                  type="button"
                  class="planning-time-toolbar__btn"
                  (click)="snapFormToNext()"
                >
                  <mat-icon fontIcon="chevron_right"></mat-icon>
                </button>
              </div>
            </div>
          </section>

          @if (activityDetailsOpen()) {
            <section class="planning-section planning-section--status planning-side-panels__full">
              <header class="planning-section__header">
                <div class="planning-section__title">Übersicht</div>
                <div class="planning-section__subtitle">
                  Dienstzuordnung und Konflikte (werden nach Speichern neu berechnet).
                </div>
              </header>
              <div class="planning-section__body">
                @if (selectedServicePreview(); as svc) {
                  <div class="planning-status">
                    <div class="planning-status__row">
                      <span class="planning-status__label">Dienst</span>
                      <span class="planning-status__value">{{ svc.label }}</span>
                    </div>
                    <div class="planning-status__row">
                      <span class="planning-status__label">Service ID</span>
                      <span class="planning-status__value planning-status__mono">{{ svc.serviceId }}</span>
                    </div>
                    @if (isSelectedServiceBoundary()) {
                      <div class="planning-status__row">
                        <span class="planning-status__label">Dienstgrenze</span>
                        <span class="planning-status__value">
                          {{ isSelectedServiceBoundaryManual() ? 'Manuell' : 'Automatisch' }}
                        </span>
                      </div>
                      @if (isSelectedServiceBoundaryManual()) {
                        <div class="planning-status__row">
                          <span class="planning-status__label"></span>
                          <span class="planning-status__value">
                            <button mat-stroked-button type="button" (click)="restoreAutomaticServiceBoundary()">
                              Automatik wiederherstellen
                            </button>
                          </span>
                        </div>
                      }
                    }
                  </div>
                }

                @if (selectedActivityConflicts().length) {
                  <div class="planning-status__conflicts">
                    <div class="planning-status__conflicts-title">Konflikte</div>
                    @for (entry of selectedActivityConflicts(); track entry.code) {
                      <div class="planning-status__conflict">
                        <span class="planning-status__conflict-kind">{{ entry.categoryLabel }}</span>
                        <span class="planning-status__conflict-text">{{ entry.label }}</span>
                        @if (entry.details?.length) {
                          <div class="planning-status__conflict-details">
                            @for (detail of entry.details; track detail) {
                              <div class="planning-status__conflict-detail">{{ detail }}</div>
                            }
                          </div>
                        }
                      </div>
                    }
                  </div>
                } @else {
                  <div class="planning-status__conflicts planning-status__conflicts--empty">
                    <div class="planning-status__conflicts-title">Konflikte</div>
                    <div class="planning-status__conflict-text">Keine Konflikte.</div>
                  </div>
                }
              </div>
            </section>

            <section class="planning-section planning-section--details planning-side-panels__full">
              <header class="planning-section__header">
                <div class="planning-section__title">Details</div>
                <div class="planning-section__subtitle">
                  Bemerkung und Zusatzinfos.
                </div>
              </header>
              <div class="planning-section__body">
                @if (definitionHasField(selectedActivityDefinition(), 'remark')) {
                  <mat-form-field appearance="outline" class="planning-type-editor__remark">
                    <mat-label>Bemerkung</mat-label>
                    <textarea matInput rows="2" formControlName="remark"></textarea>
                  </mat-form-field>
                }
              </div>
            </section>
          }
          <div class="planning-panel__actions planning-side-panels__full">
            @if (isSelectedActivityPending()) {
              <button mat-button type="button" (click)="resetPendingActivityEdits()">
                Rückgängig
              </button>
            }
            <button mat-button type="button" (click)="clearSelectedActivity()">
              {{ isSelectedActivityPending() ? 'Panel schließen' : 'Abbrechen' }}
            </button>
            <button
              mat-button
              type="button"
              (click)="duplicateSelectedActivity()"
              [disabled]="isSelectedActivityPending()"
            >
              Duplizieren
            </button>
            <button
              mat-button
              type="button"
              (click)="saveSelectedActivityToTemplate()"
              [disabled]="isSelectedActivityPending() || !selectedTemplateId()"
            >
              Als Vorlage
            </button>
            <button mat-button color="warn" type="button" (click)="deleteSelectedActivity()">
              Löschen
            </button>
            <button
              mat-flat-button
              color="primary"
              type="submit"
              [disabled]="activityForm.invalid || (!isSelectedActivityPending() && activityForm.pristine)"
            >
              {{ isSelectedActivityPending() ? 'Anlegen' : 'Speichern' }}
            </button>
          </div>
	        </form>
	      </div>
	    </div>
	    }
	  </section>

    </section>
  </mat-drawer-content>
</mat-drawer-container>
