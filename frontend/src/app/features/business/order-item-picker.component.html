<div class="picker">
  <div class="picker-summary">
    <div class="picker-summary__chips">
      <mat-chip-set>
        <mat-chip appearance="outlined">Treffer: {{ filteredOptions().length }}</mat-chip>
        <mat-chip appearance="outlined" color="primary">Ausgewählt: {{ selectedCount() }}</mat-chip>
      </mat-chip-set>
    </div>
    <div class="picker-summary__actions">
      <button mat-stroked-button color="primary" type="button" (click)="clearSelection()" [disabled]="!selectedCount()">
        Auswahl leeren
      </button>
    </div>
  </div>

  <div class="picker-selected" *ngIf="selectedOptions().length">
    <span>Auswahl:</span>
    <mat-chip-set>
      @for (option of selectedOptions(); track option.itemId) {
        <mat-chip appearance="outlined" [removable]="true" (removed)="toggleSelection(option.itemId)">
          {{ option.itemName }}
          <mat-icon matChipRemove>close</mat-icon>
        </mat-chip>
      }
    </mat-chip-set>
  </div>

  <div class="picker-filters">
    <mat-form-field appearance="outline">
      <mat-label>Suchen</mat-label>
      <mat-icon matPrefix>search</mat-icon>
      <input matInput placeholder="Auftrag oder Position" (input)="updateSearch($any($event.target).value)" />
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Sortieren</mat-label>
      <mat-select [value]="sortField()" (valueChange)="updateSort($event)">
        <mat-option value="order">Auftrag · Name</mat-option>
        <mat-option value="name">Name</mat-option>
        <mat-option value="type">Typ</mat-option>
        <mat-option value="start">Erste Abfahrt</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Auftrag</mat-label>
      <mat-select [value]="orderFilter()" (valueChange)="updateOrder($event)">
        <mat-option value="all">Alle Aufträge</mat-option>
        @for (order of orderOptions(); track order.id) {
          <mat-option [value]="order.id">{{ order.name }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  <div class="quick-filters">
    <mat-chip-set aria-label="Schnellfilter Typ">
      <mat-chip-option [selected]="typeFilter() === 'all'" (selectionChange)="updateType('all')">
        Alle Typen
      </mat-chip-option>
      @for (type of typeOptions(); track type) {
        <mat-chip-option [selected]="typeFilter() === type" (selectionChange)="updateType(type)">
          {{ type }}
        </mat-chip-option>
      }
    </mat-chip-set>
    @if (preferredOrderId && preferredOrderLabel()) {
      <mat-chip-set aria-label="Schnellfilter Auftrag">
        <mat-chip-option
          color="primary"
          [selected]="orderFilter() === preferredOrderId"
          (selectionChange)="updateOrder(preferredOrderId!)"
        >
          Bevorzugter Auftrag: {{ preferredOrderLabel() }}
        </mat-chip-option>
      </mat-chip-set>
    }
  </div>

  @if (!filteredOptions().length) {
    <div class="picker-empty">
      <mat-icon>inbox</mat-icon>
      <div>
        <strong>Keine Positionen gefunden</strong>
        <p>Bitte Filter anpassen oder die Suche zurücksetzen.</p>
      </div>
    </div>
  } @else {
    <div class="picker-options">
      @for (option of filteredOptions(); track option.itemId) {
        <button
          type="button"
          class="picker-option"
          [class.selected]="isSelected(option.itemId)"
          (click)="toggleSelection(option.itemId)"
        >
          <div class="picker-option__header">
            <div>
              <div class="picker-option__title">{{ option.itemName }}</div>
              <div class="picker-option__subtitle">{{ option.orderName }}</div>
            </div>
            <mat-chip appearance="outlined">{{ option.type }}</mat-chip>
          </div>
          <div class="picker-option__meta">
            @if (option.serviceType) {
              <span><mat-icon inline>build</mat-icon>{{ option.serviceType }}</span>
            }
            @if (option.timetableYearLabel) {
              <span><mat-icon inline>event</mat-icon>{{ option.timetableYearLabel }}</span>
            }
          </div>
          <mat-icon class="picker-option__state" color="primary">
            {{ isSelected(option.itemId) ? 'check_circle' : 'radio_button_unchecked' }}
          </mat-icon>
        </button>
      }
    </div>
  }
</div>
