<h2 mat-dialog-title>Neues Geschäft</h2>

<mat-dialog-content>
  <mat-tab-group [selectedIndex]="modeIndex()" (selectedIndexChange)="onTabChange($event)">
    <mat-tab label="Manuell">
      <form [formGroup]="form" class="create-form">
        <mat-form-field appearance="outline">
          <mat-label>Titel</mat-label>
          <input matInput formControlName="title" maxlength="80" />
          <mat-hint align="end">{{ form.value.title?.length || 0 }}/80</mat-hint>
          @if (form.controls.title.invalid && form.controls.title.touched) {
            <mat-error>Bitte einen Titel erfassen.</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Beschreibung</mat-label>
          <textarea
            matInput
            formControlName="description"
            rows="4"
            maxlength="600"
          ></textarea>
          <mat-hint align="end"
            >{{ form.value.description?.length || 0 }}/600</mat-hint
          >
          @if (
            form.controls.description.invalid && form.controls.description.touched
          ) {
            <mat-error>Bitte beschreibe das Geschäft kurz.</mat-error>
          }
        </mat-form-field>

        <div class="row">
          <mat-form-field appearance="outline">
            <mat-label>Fälligkeit</mat-label>
            <input
              matInput
              [matDatepicker]="duePicker"
              formControlName="dueDate"
              placeholder="Optional"
            />
            <mat-datepicker-toggle matIconSuffix [for]="duePicker" />
            <mat-datepicker #duePicker></mat-datepicker>
          </mat-form-field>

          <div class="assignment">
            <span class="assignment-label">Zuständig</span>
            <mat-button-toggle-group formControlName="assignmentType">
              @for (option of assignmentOptions; track option.value) {
                <mat-button-toggle [value]="option.value">
                  {{ option.label }}
                </mat-button-toggle>
              }
            </mat-button-toggle-group>
            <mat-form-field appearance="outline">
              <mat-label>Name</mat-label>
              <input
                matInput
                formControlName="assignmentName"
                placeholder="z. B. Planung"
              />
              @if (
                form.controls.assignmentName.invalid &&
                form.controls.assignmentName.touched
              ) {
                <mat-error>Bitte einen Namen angeben.</mat-error>
              }
            </mat-form-field>
          </div>
        </div>

        <mat-form-field appearance="outline">
          <mat-label>Dokumente (optional, je Zeile eines)</mat-label>
          <textarea matInput formControlName="documentNames" rows="2"></textarea>
        </mat-form-field>

        <section class="linked-items">
          <header>
            <div>
              <h3>Auftragspositionen verknüpfen</h3>
              <p>Mit den selben Filtern und Auswahlmöglichkeiten wie in „Positionen pflegen“.</p>
            </div>
            <mat-chip-set>
              <mat-chip appearance="outlined">
                Aktuell ausgewählt: {{ form.controls.linkedOrderItemIds.value.length }}
              </mat-chip>
            </mat-chip-set>
          </header>
          <app-order-item-picker
            [options]="orderItemOptions"
            [selectedIds]="form.controls.linkedOrderItemIds.value"
            (selectionChange)="onLinkedItemsChange($event)"
          />
        </section>
      </form>
    </mat-tab>
    <mat-tab label="Aus Vorlage">
      <form [formGroup]="templateForm" class="create-form">
        <mat-form-field appearance="outline">
          <mat-label>Vorlage</mat-label>
          <mat-select formControlName="templateId" required>
            @for (template of templates(); track template.id) {
              <mat-option [value]="template.id">{{ template.title }}</mat-option>
            }
          </mat-select>
          @if (templateForm.controls.templateId.invalid && templateForm.controls.templateId.touched) {
            <mat-error>Bitte Vorlage wählen.</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Zieltermin</mat-label>
          <input matInput type="date" formControlName="targetDate" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Auftragsposition (optional)</mat-label>
          <mat-select formControlName="linkedOrderItemId">
            <mat-option value="">Keine Verknüpfung</mat-option>
            @for (option of orderItemOptions; track option.itemId) {
              <mat-option [value]="option.itemId">
                {{ option.orderName }} · {{ option.itemName }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Notiz</mat-label>
          <textarea matInput rows="2" formControlName="note"></textarea>
        </mat-form-field>
      </form>
    </mat-tab>
  </mat-tab-group>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()">Abbrechen</button>
  <button mat-flat-button color="primary" (click)="save()">
    {{ mode.value === 'template' ? 'Aus Vorlage anlegen' : 'Erstellen' }}
  </button>
</mat-dialog-actions>
