<div class="md-category">
  <div class="md-category__list">
    <header class="md-category__list-header">
      <h3>{{ config.entityLabel }} ({{ items().length }})</h3>
      <button mat-stroked-button color="primary" type="button" (click)="handleCreate()">
        <mat-icon fontIcon="add"></mat-icon>
        Neu anlegen
      </button>
    </header>

    <table
      mat-table
      [dataSource]="items()"
      [trackBy]="trackById"
      class="md-category__table"
      [attr.aria-label]="config.entityLabel + ' Tabelle'"
    >
      @for (column of config.columns; track column.key) {
        <ng-container [matColumnDef]="column.key">
          <th mat-header-cell *matHeaderCellDef>{{ column.label }}</th>
          <td
            mat-cell
            *matCellDef="let row"
            (click)="handleSelect(row.id)"
            [class.is-active]="row.id === selectedId()"
          >
            {{ displayCell(row, column.key) }}
          </td>
        </ng-container>
      }

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let row">
          <button
            mat-icon-button
            type="button"
            (click)="handleSelect(row.id); $event.stopPropagation()"
            [attr.aria-label]="
              'Bearbeiten ' +
              displayCell(row, config.columns.length ? config.columns[0].key : 'id')
            "
          >
            <mat-icon fontIcon="edit"></mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns()"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns()"
        (click)="handleSelect(row.id)"
        [class.is-active]="row.id === selectedId()"
      ></tr>
    </table>
  </div>

  @if (selectedItem(); as selection) {
  <div class="md-category__detail">
    <header class="md-category__detail-header">
      <h3>{{ config.entityLabel }} bearbeiten</h3>
      <div class="md-category__detail-actions">
        <span class="md-category__detail-meta">ID {{ selection.id }}</span>
        @if (config.allowDelete !== false) {
          <button
            mat-stroked-button
            color="warn"
            type="button"
            (click)="handleDelete()"
            [disabled]="!selectedItem()"
          >
            <mat-icon fontIcon="delete"></mat-icon>
            Löschen
          </button>
        }
      </div>
    </header>

    <form [formGroup]="form" (ngSubmit)="handleSave()" class="md-category__form">
      <input type="hidden" formControlName="id" />

      <div class="md-category__form-grid">
        @for (field of config.fields; track field.key) {
          @if (isTemporalField(field)) {
            <div class="md-category__timeline-field" [formArrayName]="field.key">
              @let timelineControls = temporalControls(field.key);

              <ng-template #timelineEntry let-index="index" let-removable="removable">
                <div
                  class="md-category__timeline-entry"
                  [class.md-category__timeline-entry--current]="index === 0"
                  [formGroupName]="index"
                >
                  <mat-form-field appearance="outline" class="md-category__timeline-value">
                    <mat-label>
                      {{ index === 0 ? field.label : field.label + ' (Historie)' }}
                    </mat-label>
                    <input
                      matInput
                      [type]="temporalInputType(field)"
                      formControlName="value"
                      [placeholder]="field.placeholder ?? ''"
                    />
                    @if (temporalEntryControlHasError(field.key, index, 'value', 'required')) {
                      <mat-error>Wert ist erforderlich.</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Gültig ab</mat-label>
                    <input matInput type="date" formControlName="validFrom" />
                    @if (temporalEntryControlHasError(field.key, index, 'validFrom', 'required')) {
                      <mat-error>Bitte ein Startdatum angeben.</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Gültig bis</mat-label>
                    <input matInput type="date" formControlName="validTo" />
                    @if (temporalEntryHasGroupError(field.key, index, 'invalidRange')) {
                      <mat-error>„Gültig bis“ muss nach „Gültig ab“ liegen.</mat-error>
                    }
                  </mat-form-field>

                  <button
                    mat-icon-button
                    type="button"
                    (click)="removeTemporalEntry(field.key, index)"
                    [disabled]="!removable"
                    aria-label="Zeitraum entfernen"
                  >
                    <mat-icon fontIcon="delete"></mat-icon>
                  </button>
                </div>
              </ng-template>

              <div class="md-category__timeline-row">
                <ng-container
                  [ngTemplateOutlet]="timelineEntry"
                  [ngTemplateOutletContext]="{
                    index: 0,
                    removable: timelineControls.length > 1
                  }"
                ></ng-container>

                <div class="md-category__timeline-actions">
                  <button
                    mat-icon-button
                    type="button"
                    class="md-category__timeline-action"
                    [disabled]="timelineControls.length <= 1"
                    (click)="toggleTemporalHistory(field.key)"
                    [attr.aria-label]="
                      isTemporalHistoryVisible(field.key)
                        ? 'Historie verbergen'
                        : 'Historie anzeigen'
                    "
                    [matTooltip]="
                      timelineControls.length <= 1
                        ? 'Keine Historie vorhanden'
                        : isTemporalHistoryVisible(field.key)
                          ? 'Historie verbergen'
                          : 'Historie anzeigen'
                    "
                    [matTooltipDisabled]="timelineControls.length <= 1"
                  >
                    <mat-icon
                      [fontIcon]="
                        isTemporalHistoryVisible(field.key)
                          ? 'history_toggle_off'
                          : 'history'
                      "
                    ></mat-icon>
                  </button>

                  <button
                    mat-icon-button
                    type="button"
                    class="md-category__timeline-action"
                    (click)="addTemporalEntry(field)"
                    aria-label="Zeitraum hinzufügen"
                    matTooltip="Zeitraum hinzufügen"
                  >
                    <mat-icon fontIcon="add"></mat-icon>
                  </button>
                </div>
              </div>

              @if (field.hint) {
                <span class="md-category__timeline-hint">{{ field.hint }}</span>
              }

              @if (isTemporalHistoryVisible(field.key)) {
                <div class="md-category__timeline-history">
                  @for (control of timelineControls.controls; track $index; let index = $index) {
                    @if (index > 0) {
                      <ng-container
                        [ngTemplateOutlet]="timelineEntry"
                        [ngTemplateOutletContext]="{ index: index, removable: true }"
                      ></ng-container>
                    }
                  }
                </div>
              }

              @if (timelineControls.invalid && (timelineControls.dirty || timelineControls.touched) && timelineControls.errors; as errors) {
                <div class="md-category__timeline-error">
                  <mat-icon fontIcon="warning"></mat-icon>
                  @if (errors['missingStart']) {
                    <span>Bitte für jeden Zeitraum ein Startdatum angeben.</span>
                  }
                  @if (errors['invalidRange']) {
                    <span>„Gültig bis“ muss nach „Gültig ab“ liegen.</span>
                  }
                  @if (errors['overlap']) {
                    <span>Zeiträume dürfen sich nicht überschneiden.</span>
                  }
                </div>
              }
            </div>
          } @else {
            <div class="md-category__field" [class.md-category__field--boolean]="field.type === 'boolean'">
              @switch (field.type) {
                @case ('text') {
                  <mat-form-field appearance="outline">
                    <mat-label>{{ field.label }}</mat-label>
                    <input
                      matInput
                      [formControlName]="field.key"
                      [placeholder]="field.placeholder ?? ''"
                    />
                    @if (canClearField(field)) {
                      <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        class="md-category__field-clear"
                        [disabled]="isFieldEmpty(field)"
                        (click)="clearField(field)"
                        aria-label="Feld leeren"
                        matTooltip="Feld leeren"
                      >
                        <mat-icon fontIcon="close"></mat-icon>
                      </button>
                    }
                    @if (field.hint) {
                      <mat-hint>{{ field.hint }}</mat-hint>
                    }
                  </mat-form-field>
                }
                @case ('textarea') {
                  <mat-form-field appearance="outline">
                    <mat-label>{{ field.label }}</mat-label>
                    <textarea
                      matInput
                      [formControlName]="field.key"
                      [placeholder]="field.placeholder ?? ''"
                      rows="3"
                    ></textarea>
                    @if (canClearField(field)) {
                      <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        class="md-category__field-clear"
                        [disabled]="isFieldEmpty(field)"
                        (click)="clearField(field)"
                        aria-label="Feld leeren"
                        matTooltip="Feld leeren"
                      >
                        <mat-icon fontIcon="close"></mat-icon>
                      </button>
                    }
                    @if (field.hint) {
                      <mat-hint>{{ field.hint }}</mat-hint>
                    }
                  </mat-form-field>
                }
                @case ('number') {
                  <mat-form-field appearance="outline">
                    <mat-label>{{ field.label }}</mat-label>
                    <input
                      matInput
                      type="number"
                      [formControlName]="field.key"
                      [placeholder]="field.placeholder ?? ''"
                    />
                    @if (canClearField(field)) {
                      <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        class="md-category__field-clear"
                        [disabled]="isFieldEmpty(field)"
                        (click)="clearField(field)"
                        aria-label="Feld leeren"
                        matTooltip="Feld leeren"
                      >
                        <mat-icon fontIcon="close"></mat-icon>
                      </button>
                    }
                    @if (field.hint) {
                      <mat-hint>{{ field.hint }}</mat-hint>
                    }
                  </mat-form-field>
                }
                @case ('date') {
                  <mat-form-field appearance="outline">
                    <mat-label>{{ field.label }}</mat-label>
                    <input
                      matInput
                      type="date"
                      [formControlName]="field.key"
                      [placeholder]="field.placeholder ?? ''"
                    />
                    @if (canClearField(field)) {
                      <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        class="md-category__field-clear"
                        [disabled]="isFieldEmpty(field)"
                        (click)="clearField(field)"
                        aria-label="Feld leeren"
                        matTooltip="Feld leeren"
                      >
                        <mat-icon fontIcon="close"></mat-icon>
                      </button>
                    }
                    @if (field.hint) {
                      <mat-hint>{{ field.hint }}</mat-hint>
                    }
                  </mat-form-field>
                }
                @case ('time') {
                  <mat-form-field appearance="outline">
                    <mat-label>{{ field.label }}</mat-label>
                    <input
                      matInput
                      type="time"
                      [formControlName]="field.key"
                      [placeholder]="field.placeholder ?? ''"
                    />
                    @if (canClearField(field)) {
                      <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        class="md-category__field-clear"
                        [disabled]="isFieldEmpty(field)"
                        (click)="clearField(field)"
                        aria-label="Feld leeren"
                        matTooltip="Feld leeren"
                      >
                        <mat-icon fontIcon="close"></mat-icon>
                      </button>
                    }
                    @if (field.hint) {
                      <mat-hint>{{ field.hint }}</mat-hint>
                    }
                  </mat-form-field>
                }
                @case ('select') {
                  <mat-form-field appearance="outline">
                    <mat-label>{{ field.label }}</mat-label>
                    <mat-select
                      [formControlName]="field.key"
                      [placeholder]="field.placeholder ?? ''"
                    >
                      @for (option of fieldOptions(field); track option.value) {
                        <mat-option [value]="option.value">
                          {{ option.label }}
                        </mat-option>
                      }
                    </mat-select>
                    @if (canClearField(field)) {
                      <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        class="md-category__field-clear"
                        [disabled]="isFieldEmpty(field)"
                        (click)="clearField(field)"
                        aria-label="Feld leeren"
                        matTooltip="Feld leeren"
                      >
                        <mat-icon fontIcon="close"></mat-icon>
                      </button>
                    }
                    @if (field.hint) {
                      <mat-hint>{{ field.hint }}</mat-hint>
                    }
                  </mat-form-field>
                }
                @case ('multiselect') {
                  <mat-form-field appearance="outline">
                    <mat-label>{{ field.label }}</mat-label>
                    <mat-select
                      [formControlName]="field.key"
                      [placeholder]="field.placeholder ?? ''"
                      multiple
                    >
                      @for (option of fieldOptions(field); track option.value) {
                        <mat-option [value]="option.value">
                          {{ option.label }}
                        </mat-option>
                      }
                    </mat-select>
                    @if (canClearField(field)) {
                      <button
                        mat-icon-button
                        matSuffix
                        type="button"
                        class="md-category__field-clear"
                        [disabled]="isFieldEmpty(field)"
                        (click)="clearField(field)"
                        aria-label="Feld leeren"
                        matTooltip="Feld leeren"
                      >
                        <mat-icon fontIcon="close"></mat-icon>
                      </button>
                    }
                    @if (field.hint) {
                      <mat-hint>{{ field.hint }}</mat-hint>
                    }
                  </mat-form-field>
                }
                @case ('boolean') {
                  <div class="md-category__boolean-field">
                    <mat-slide-toggle [formControlName]="field.key">
                      {{ field.label }}
                    </mat-slide-toggle>
                    @if (field.hint) {
                      <span class="md-category__boolean-hint">{{ field.hint }}</span>
                    }
                  </div>
                }
              }
            </div>
          }
        }
      </div>

      <div class="md-category__form-actions">
        <button mat-stroked-button type="button" (click)="handleSelect(selection.id)">
          Änderungen verwerfen
        </button>
        <button mat-flat-button color="primary" type="submit">Speichern</button>
      </div>
    </form>
  </div>
  }
</div>
