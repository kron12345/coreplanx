<section class="vehicle-editor">
  <header>
    <mat-button-toggle-group color="primary" [value]="viewMode()" (valueChange)="viewMode.set($event)">
      <mat-button-toggle value="servicePools">
        <mat-icon fontIcon="layers"></mat-icon>
        Fahrzeugdienstpools
      </mat-button-toggle>
      <mat-button-toggle value="services">
        <mat-icon fontIcon="route"></mat-icon>
        Fahrzeugdienste
      </mat-button-toggle>
      <mat-button-toggle value="vehiclePools">
        <mat-icon fontIcon="warehouse"></mat-icon>
        Fahrzeugpools
      </mat-button-toggle>
      <mat-button-toggle value="vehicles">
        <mat-icon fontIcon="directions_transit"></mat-icon>
        Fahrzeuge
      </mat-button-toggle>
      <mat-button-toggle value="vehicleTypes">
        <mat-icon fontIcon="train"></mat-icon>
        Fahrzeugtypen
      </mat-button-toggle>
      <mat-button-toggle value="compositions">
        <mat-icon fontIcon="stacked_bar_chart"></mat-icon>
        Kompositionen
      </mat-button-toggle>
      <mat-button-toggle value="system">
        <mat-icon fontIcon="delete_sweep"></mat-icon>
        System
      </mat-button-toggle>
    </mat-button-toggle-group>

    <button mat-stroked-button color="warn" type="button" (click)="resetToDefaults()">
      Werkseinstellungen
    </button>
  </header>

  @switch (viewMode()) {
    @case ('servicePools') {
      <app-attribute-entity-editor
        [title]="'Fahrzeugdienstpools'"
        [entities]="servicePoolRecords()"
        [attributeDefinitions]="servicePoolDefinitions()"
        [defaultFallbackValues]="servicePoolDefaults"
        [detailError]="servicePoolError()"
        [requiredKeys]="servicePoolRequiredKeys"
        (saveEntity)="handleServicePoolSave($event)"
        (deleteEntities)="handleServicePoolDelete($event)"
      />
    }
    @case ('services') {
      <app-attribute-entity-editor
        [title]="'Fahrzeugdienste'"
        [entities]="serviceRecords()"
        [attributeDefinitions]="serviceDefinitions()"
        [defaultFallbackValues]="serviceDefaults"
        [detailError]="serviceError()"
        [groupedEntities]="serviceGroups()"
        [createDefaultsFactory]="serviceCreateDefaultsFactory"
        [selectOptions]="serviceSelectOptions()"
        (saveEntity)="handleServiceSave($event)"
        (deleteEntities)="handleServiceDelete($event)"
      />
    }
    @case ('vehiclePools') {
      <app-attribute-entity-editor
        [title]="'Fahrzeugpools'"
        [entities]="vehiclePoolRecords()"
        [attributeDefinitions]="vehiclePoolDefinitions()"
        [defaultFallbackValues]="vehiclePoolDefaults"
        [detailError]="vehiclePoolError()"
        [requiredKeys]="vehiclePoolRequiredKeys"
        (saveEntity)="handleVehiclePoolSave($event)"
        (deleteEntities)="handleVehiclePoolDelete($event)"
      />
    }
    @case ('vehicles') {
      <app-attribute-entity-editor
        [title]="'Fahrzeuge'"
        [entities]="vehicleRecords()"
        [attributeDefinitions]="vehicleDefinitions()"
        [defaultFallbackValues]="vehicleDefaults"
        [detailError]="vehicleError()"
        [groupedEntities]="vehicleGroups()"
        [createDefaultsFactory]="vehicleCreateDefaultsFactory"
        [selectOptions]="vehicleSelectOptions()"
        [multiSelectOptions]="vehicleMultiSelectOptions()"
        (saveEntity)="handleVehicleSave($event)"
        (deleteEntities)="handleVehicleDelete($event)"
      />
    }
    @case ('vehicleTypes') {
      <app-attribute-entity-editor
        [title]="'Fahrzeugtypen'"
        [entities]="vehicleTypeRecords()"
        [attributeDefinitions]="vehicleTypeDefinitions()"
        [defaultFallbackValues]="vehicleTypeDefaults"
        [detailError]="vehicleTypeError()"
        [requiredKeys]="vehicleTypeRequiredKeys"
        [numericKeys]="vehicleTypeNumericKeys"
        [selectOptions]="vehicleTypeSelectOptions"
        (saveEntity)="handleVehicleTypeSave($event)"
        (deleteEntities)="handleVehicleTypeDelete($event)"
      />
    }
    @case ('compositions') {
      <app-attribute-entity-editor
        [title]="'Fahrzeugkompositionen'"
        [entities]="compositionRecords()"
        [attributeDefinitions]="compositionDefinitions()"
        [defaultFallbackValues]="compositionDefaults"
        [detailError]="compositionError()"
        [requiredKeys]="compositionRequiredKeys"
        (saveEntity)="handleCompositionSave($event)"
        (deleteEntities)="handleCompositionDelete($event)"
      />
    }
    @case ('system') {
      <div class="system-pools">
        <div class="system-pools__intro">
          System-Pools sind schreibgesch체tzt. Ziehe Eintr채ge in einen Zielpool, um sie wieder zu aktivieren.
        </div>

        <div class="system-pools__section" cdkDropListGroup>
          <div class="system-pool-card">
            <div class="system-pool-card__header">
              <div>
                <div class="system-pool-card__title">{{ systemPoolLabels.vehicleServicePool }}</div>
                <div class="system-pool-card__meta">
                  {{ systemServiceItems().length }} Dienste
                </div>
              </div>
            </div>
            <div class="system-pool-card__list" cdkDropList [cdkDropListData]="systemPoolIds.vehicleServicePool">
              @if (!systemServiceItems().length) {
                <div class="system-pool-card__empty">Keine Eintr채ge im System-Pool.</div>
              }
              @for (service of systemServiceItems(); track service.id) {
                <div class="system-item" cdkDrag [cdkDragData]="service.id">
                  <div class="system-item__title">{{ service.name }}</div>
                  <div class="system-item__meta">{{ service.id }}</div>
                </div>
              }
            </div>
          </div>
          <div class="system-targets">
            @for (pool of servicePoolTargets(); track pool.id) {
              <div
                class="system-target"
                cdkDropList
                [cdkDropListData]="pool.id"
                (cdkDropListDropped)="handleSystemServiceDrop($event)"
              >
                <div class="system-target__title">{{ pool.name }}</div>
                <div class="system-target__meta">
                  {{ serviceCountByPool().get(pool.id) ?? 0 }} Dienste
                </div>
                <div class="system-target__hint">Hier ablegen</div>
              </div>
            }
          </div>
        </div>

        <div class="system-pools__section" cdkDropListGroup>
          <div class="system-pool-card">
            <div class="system-pool-card__header">
              <div>
                <div class="system-pool-card__title">{{ systemPoolLabels.vehiclePool }}</div>
                <div class="system-pool-card__meta">
                  {{ systemVehicleItems().length }} Fahrzeuge
                </div>
              </div>
            </div>
            <div class="system-pool-card__list" cdkDropList [cdkDropListData]="systemPoolIds.vehiclePool">
              @if (!systemVehicleItems().length) {
                <div class="system-pool-card__empty">Keine Eintr채ge im System-Pool.</div>
              }
              @for (vehicle of systemVehicleItems(); track vehicle.id) {
                <div class="system-item" cdkDrag [cdkDragData]="vehicle.id">
                  <div class="system-item__title">
                    {{ vehicle.vehicleNumber }}
                  </div>
                  <div class="system-item__meta">{{ vehicle.id }}</div>
                </div>
              }
            </div>
          </div>
          <div class="system-targets">
            @for (pool of vehiclePoolTargets(); track pool.id) {
              <div
                class="system-target"
                cdkDropList
                [cdkDropListData]="pool.id"
                (cdkDropListDropped)="handleSystemVehicleDrop($event)"
              >
                <div class="system-target__title">{{ pool.name }}</div>
                <div class="system-target__meta">
                  {{ vehicleCountByPool().get(pool.id) ?? 0 }} Fahrzeuge
                </div>
                <div class="system-target__hint">Hier ablegen</div>
              </div>
            }
          </div>
        </div>
      </div>
    }
  }
</section>
