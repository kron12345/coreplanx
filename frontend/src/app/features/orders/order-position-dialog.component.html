<h2 mat-dialog-title>Auftragsposition hinzufügen</h2>

<mat-dialog-content>
  <div class="dialog-stack">
    <mat-tab-group
      class="mode-tabs"
      [selectedIndex]="modeIndex()"
      (selectedIndexChange)="onModeTabChange($event)"
    >
      <mat-tab label="Leistung">
        <app-order-position-service-tab
          [form]="serviceForm"
          [generalLabels]="serviceGeneralLabels"
          [generalDescriptions]="serviceGeneralDescriptions"
          [serviceFieldsConfig]="serviceFieldsConfig"
          [serviceFieldDescriptions]="serviceFieldDescriptions"
        />
      </mat-tab>

      <mat-tab label="Fahrplan (Serie)">
        <app-order-position-plan-tab
          [form]="planForm"
          [templates]="templates()"
          [fieldDescriptions]="planFieldDescriptions"
          [requiresRollingStock]="requiresRollingStock"
          [stopOptions]="planStopOptions"
          [baseVehicles]="compositionBaseVehicles"
          [changeEntries]="compositionChangeEntries"
          [baseVehicleFactory]="compositionBaseFactory"
          [changeEntryFactory]="compositionChangeFactory"
          [simulationSelectionLabel]="simulationSelectionLabel('plan')"
          (createTemplateRequested)="openTemplateCreateDialog()"
          (simulationAssignmentRequested)="openSimulationAssignment('plan')"
        />
      </mat-tab>

      <mat-tab label="Fahrplan (manuell)">
        <app-order-position-manual-tab
          [manualTemplate]="manualTemplate()"
          [form]="manualPlanForm"
          [generalLabels]="manualGeneralLabels"
          [generalDescriptions]="manualGeneralDescriptions"
          [fieldDescriptions]="manualFieldDescriptions"
          [requiresRollingStock]="requiresRollingStock"
          [stopOptions]="manualStopOptions"
          [baseVehicles]="compositionBaseVehicles"
          [changeEntries]="compositionChangeEntries"
          [baseVehicleFactory]="compositionBaseFactory"
          [changeEntryFactory]="compositionChangeFactory"
          [simulationSelectionLabel]="simulationSelectionLabel('manual')"
          (assemblePlanRequested)="openManualPlanAssembly()"
          (clearTemplateRequested)="clearManualTemplate()"
          (simulationAssignmentRequested)="openSimulationAssignment('manual')"
        />
      </mat-tab>

      <mat-tab label="Fahrplan (Import)">
        <app-order-position-import-tab
          [importError]="importError()"
          [importedTrainsLength]="importedTrains().length"
          [filteredTrains]="filteredTrains()"
          [selectedTrainIds]="selectedTrainIds()"
          [expandedTrainIds]="expandedTrainIds()"
          [hasTaktTemplates]="taktTemplates().length > 0"
          [importOptionsForm]="importOptionsForm"
          [trafficPeriods]="trafficPeriods()"
          [managedTimetableYears]="managedTimetableYears()"
          [importOptionsDescriptions]="importOptionsDescriptions"
          [simulationSelectionLabel]="simulationSelectionLabel('import')"
          [requiresRollingStock]="requiresRollingStock"
          [baseVehicles]="compositionBaseVehicles"
          [changeEntries]="compositionChangeEntries"
          [baseVehicleFactory]="compositionBaseFactory"
          [importFilters]="importFilters"
          [importFilterDescriptions]="importFilterDescriptions"
          [taktTemplates]="taktTemplates()"
          (railMlFileSelected)="onRailMlFileSelected($event)"
          (clearImportedDataRequested)="clearImportedData()"
          (simulationAssignmentRequested)="openSimulationAssignment('import')"
          (importFiltersResetRequested)="onImportFiltersReset()"
          (selectAllFilteredRequested)="selectAllFiltered($event)"
          (trainSelectionToggled)="toggleTrainSelection($event.id, $event.selected)"
          (trainExpansionToggled)="toggleTrainExpansion($event.id, $event.event)"
        />
      </mat-tab>
    </mat-tab-group>

    <section class="calendar-section">
      <div class="calendar-section__header">
        <h3>Referenzkalender</h3>
        <p>Definiere hier die Einsatztage oder Serienfahrten. Der Kalender nutzt die gesamte Breite.</p>
      </div>

      @switch (mode()) {
        @case ('service') {
          <app-reference-calendar-inline-form
            [yearControl]="serviceCalendarYearControl"
            [datesControl]="serviceCalendarDatesControl"
            [excludedDatesControl]="serviceCalendarExclusionsControl"
            title="Kalender für Leistungen"
            description="Wähle alle Tage, an denen die Leistung stattfinden soll."
            [fixedYearLabel]="orderYearLabel"
          ></app-reference-calendar-inline-form>
        }
        @case ('plan') {
          <app-reference-calendar-inline-form
            [yearControl]="planCalendarYearControl"
            [datesControl]="planCalendarDatesControl"
            [excludedDatesControl]="planCalendarExclusionsControl"
            title="Kalender für Serienfahrten"
            description="Die Auswahl wird beim Rollout als Referenzkalender hinterlegt."
            [fixedYearLabel]="orderYearLabel"
          ></app-reference-calendar-inline-form>
        }
        @case ('manualPlan') {
          <app-reference-calendar-inline-form
            [yearControl]="manualCalendarYearControl"
            [datesControl]="manualCalendarDatesControl"
            [excludedDatesControl]="manualCalendarExclusionsControl"
            title="Kalender für manuelle Fahrten"
            description="Füge einzelne Fahrtage für den manuellen Fahrplan hinzu."
            [fixedYearLabel]="orderYearLabel"
          ></app-reference-calendar-inline-form>
        }
        @case ('import') {
          <div class="calendar-placeholder">
            <mat-icon>info</mat-icon>
            RailML-Import verwendet die Kalender je Zuggruppe automatisch.
          </div>
        }
      }

      @if (mode() === 'plan') {
        <div class="plan-preview-panel">
        @if (selectedTemplate(); as template) {
          @let stats = planTemplateStats(template);
          @let preview = planPreview();
          <div class="plan-preview__header">
            <div>
              <div class="plan-preview__title">{{ template.title }}</div>
              <div class="plan-preview__subtitle">
                {{ template.trainNumber }} · {{ template.category }}
              </div>
            </div>
            <mat-chip-set>
              @if (template.recurrence) {
                <mat-chip>
                  <mat-icon>schedule</mat-icon>
                  {{ template.recurrence.startTime }} – {{ template.recurrence.endTime }}
                </mat-chip>
                <mat-chip>
                  <mat-icon>repeat</mat-icon>
                  alle {{ template.recurrence.intervalMinutes }} min
                </mat-chip>
                <mat-chip>
                  <mat-icon>calendar_today</mat-icon>
                  {{ template.recurrence.days.join(', ') }}
                </mat-chip>
              }
            </mat-chip-set>
          </div>

          @if (stats) {
            <div class="plan-preview__template">
              <div class="plan-preview__route">
                <span>{{ stats.origin }}</span>
                <mat-icon>chevron_right</mat-icon>
                <span>{{ stats.destination }}</span>
              </div>
              <div class="plan-preview__meta">
                <span>{{ stats.stopCount }} Halte</span>
                @if (stats.travelLabel) {
                  <span>{{ stats.travelLabel }}</span>
                }
                <span>Verantwortlich: {{ template.responsibleRu }}</span>
              </div>
              <div class="plan-preview__stops">
                @for (stop of stats.stopNames; track stop; let idx = $index) {
                  <span class="plan-preview__stop">
                    <mat-icon>{{ idx === 0 ? 'play_arrow' : idx === stats.stopNames.length - 1 ? 'stop' : 'radio_button_checked' }}</mat-icon>
                    {{ stop }}
                  </span>
                }
              </div>
            </div>
          } @else {
            <ng-container [ngTemplateOutlet]="planPreviewNoStats"></ng-container>
          }
          <ng-template #planPreviewNoStats>
            <div class="plan-preview__placeholder">
              Vorlage enthält keine Halte.
            </div>
          </ng-template>

          <div class="plan-preview__summary" [class.plan-preview__summary--invalid]="!preview.ready">
            <div class="plan-preview__stat">
              <span>Züge</span>
              <strong>{{ preview.ready ? preview.totalDepartures : '—' }}</strong>
            </div>
            <div class="plan-preview__stat">
              <span>Zeitraum</span>
              <strong>{{ preview.durationLabel || '—' }}</strong>
            </div>
            <div class="plan-preview__stat">
              <span>OTN</span>
              <strong>{{ preview.otnRange || '—' }}</strong>
            </div>
            <div class="plan-preview__stat">
              <span>Erste/Letzte</span>
              <strong>{{ preview.firstDeparture || '--:--' }} · {{ preview.lastDeparture || '--:--' }}</strong>
            </div>
          </div>

          @if (preview.warnings.length) {
            <div class="plan-preview__warnings">
              <mat-icon>warning</mat-icon>
              <div>
                @for (warn of preview.warnings; track warn) {
                  <div>{{ warn }}</div>
                }
              </div>
            </div>
          } @else if (preview.sampleDepartures.length) {
            <div class="plan-preview__samples">
              <span class="plan-preview__samples-label">Beispielabfahrten</span>
              <div class="plan-preview__samples-list">
                @for (dep of preview.sampleDepartures; track dep) {
                  <span class="plan-preview__sample-chip">{{ dep }}</span>
                }
                @if (preview.totalDepartures > preview.sampleDepartures.length) {
                  <span class="plan-preview__sample-chip plan-preview__sample-chip--muted">
                    +{{ preview.totalDepartures - preview.sampleDepartures.length }} weitere
                  </span>
                }
              </div>
            </div>
          }
        } @else {
          <div class="plan-preview__placeholder">
            <mat-icon>visibility</mat-icon>
            <div>Wähle eine Vorlage aus, um eine Vorschau der Serie zu erhalten.</div>
          </div>
        }
      </div>
      }
    </section>

    <form [formGroup]="businessForm" class="business-section">
      <div class="business-section__header">
        <div>
          <h3>Geschäftsverknüpfung</h3>
          <p>
            Verknüpfe neue Positionen mit einem bestehenden Geschäft oder starte direkt eine
            Geschäftsvorlage (inkl. TTR-Automationen).
          </p>
        </div>
        <mat-button-toggle-group formControlName="mode" appearance="legacy" class="business-section__mode">
          <mat-button-toggle value="none">Ohne Geschäft</mat-button-toggle>
          <mat-button-toggle value="existing">Bestehend</mat-button-toggle>
          <mat-button-toggle value="template">Vorlage</mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      @if (businessForm.controls.mode.value === 'existing') {
        <mat-form-field appearance="outline">
          <mat-label>Geschäft auswählen</mat-label>
          <mat-select formControlName="existingBusinessId">
            @if (!businessOptions().length) {
              <mat-option disabled>Keine Geschäfte verfügbar</mat-option>
            } @else {
              @for (business of businessOptions(); track business.id) {
                <mat-option [value]="business.id">
                  {{ business.title }} · {{ business.assignment.name }}
                </mat-option>
              }
            }
          </mat-select>
          @if (businessForm.controls.existingBusinessId.hasError('required')) {
            <mat-error>Bitte ein Geschäft auswählen.</mat-error>
          }
        </mat-form-field>
      }

      @if (businessForm.controls.mode.value === 'template') {
        <div class="business-section__template">
          <mat-form-field appearance="outline">
            <mat-label>Geschäftsvorlage</mat-label>
            <mat-select formControlName="templateId">
              @for (template of businessTemplates(); track template.id) {
                <mat-option [value]="template.id">{{ template.title }}</mat-option>
              }
            </mat-select>
            @if (businessForm.controls.templateId.hasError('required')) {
              <mat-error>Vorlage erforderlich.</mat-error>
            }
          </mat-form-field>

          <div class="business-section__grid">
            <mat-form-field appearance="outline">
              <mat-label>Individueller Titel</mat-label>
              <input matInput formControlName="customTitle" placeholder="z. B. TTR Abstimmung Q3" />
            </mat-form-field>
            <mat-form-field appearance="outline">
              <mat-label>Zieldatum</mat-label>
              <input matInput type="date" formControlName="targetDate" />
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="business-section__note">
            <mat-label>Hinweise</mat-label>
            <textarea
              matInput
              rows="2"
              formControlName="note"
              placeholder="Informationen für Geschäfts-Team oder Automationen"
            ></textarea>
          </mat-form-field>

          <mat-slide-toggle formControlName="enableAutomations">
            Automationen aus der Vorlage aktivieren (z. B. TTR-Meldungen)
          </mat-slide-toggle>

          @if (businessAutomationsForSelection().length) {
            <div
              class="business-section__automations"
              [class.business-section__automations--disabled]="!businessForm.controls.enableAutomations.value"
            >
              <p>
                @if (businessForm.controls.enableAutomations.value) {
                  Automationen auswählen, die beim Erstellen ausgelöst werden.
                } @else {
                  Automationen sind aktuell deaktiviert.
                }
              </p>
              <div class="automation-options">
                @for (rule of businessAutomationsForSelection(); track rule.id) {
                  <mat-checkbox
                    [checked]="businessForm.controls.automationRuleIds.value.includes(rule.id)"
                    (change)="onAutomationToggle(rule.id, $event.checked)"
                    [disabled]="!businessForm.controls.enableAutomations.value"
                  >
                    <div class="automation-option">
                      <strong>{{ rule.title }}</strong>
                      <small>{{ rule.trigger }} · {{ rule.condition }}</small>
                    </div>
                  </mat-checkbox>
                }
              </div>
            </div>
          } @else {
            <p class="business-section__automations-hint">
              Diese Vorlage enthält noch keine Automationen.
            </p>
          }
        </div>
      }
    </form>
  </div>

  @if (errorMessage()) {
    <p class="error">{{ errorMessage() }}</p>
  }
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="cancel()">Abbrechen</button>
  <button mat-flat-button color="primary" (click)="save()">Speichern</button>
</mat-dialog-actions>
