@if (rows().length > 0) {
<div class="attributes">
  <table class="attributes__table">
    <thead>
      <tr>
        <th>Gültig ab</th>
        <th>Attribut</th>
        <th>Wert</th>
        <th class="actions">Aktionen</th>
      </tr>
    </thead>
    <tbody>
      @for (row of rows(); track row.key) {
        <tr [class.has-error]="hasError(row.key)">
          <td>
            <input
              type="date"
              [disabled]="!row.temporal"
              [ngModel]="row.validFrom"
              (ngModelChange)="updateRowField(row.key, 'validFrom', $event || '')"
            />
          </td>
          <td>
            <div class="attr-label">
              <span>{{ row.label }}</span>
              @if (actionKeys.includes(row.key)) {
                <button
                  mat-icon-button
                  type="button"
                  (click)="actionTriggered.emit(row.key)"
                  matTooltip="Spezielle Aktion"
                >
                  <mat-icon>open_in_new</mat-icon>
                </button>
              }
              @if (row.temporal) {
                <button
                  mat-icon-button
                  type="button"
                  (click)="toggleHistory(row.key)"
                  matTooltip="Historie anzeigen"
                >
                  <mat-icon>
                    {{ historyDrawerFor() === row.key ? 'history_toggle_off' : 'history' }}
                  </mat-icon>
                </button>
              }
            </div>
          </td>
          <td>
            @if (hasMultiSelectOptions(row.key)) {
              <mat-form-field appearance="outline" class="select-field">
                <mat-select
                  multiple
                  [ngModel]="multiSelectModel(row.key, row.value)"
                  (ngModelChange)="updateMultiSelectRow(row.key, $event)"
                >
                  <cdk-virtual-scroll-viewport itemSize="48" class="select-viewport">
                    <mat-option
                      *cdkVirtualFor="let option of multiSelectOptions[row.key]; trackBy: trackOption"
                      [value]="option.value"
                    >
                      {{ option.label }}
                    </mat-option>
                  </cdk-virtual-scroll-viewport>
                </mat-select>
              </mat-form-field>
            } @else if (hasSelectOptions(row.key)) {
              <mat-form-field appearance="outline" class="select-field">
                <mat-select
                  [ngModel]="row.value"
                  (ngModelChange)="updateRowField(row.key, 'value', $event || '')"
                >
                  @for (option of selectOptions[row.key]; track option.value) {
                    <mat-option [value]="option.value">
                      {{ option.label }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            } @else {
              <input
                type="text"
                [ngModel]="row.value"
                (ngModelChange)="updateRowField(row.key, 'value', $event || '')"
              />
            }
          </td>
          <td class="row-actions">
            <button
              mat-icon-button
              color="primary"
              type="button"
              (click)="saveRow(row.key)"
              matTooltip="Speichern"
            >
              <mat-icon>check</mat-icon>
            </button>
            <button
              mat-icon-button
              type="button"
              (click)="resetRow(row.key)"
              matTooltip="Zurücksetzen"
            >
              <mat-icon>close</mat-icon>
            </button>
          </td>
        </tr>
        @if (historyDrawerFor() === row.key) {
          <tr class="history-row" @historyDrawer>
            <td colspan="4">
              <div class="history-panel">
                <header>
                  <span>Historie – {{ row.label }}</span>
                  <button mat-stroked-button type="button" (click)="addHistoryEntry(row.key)">
                    <mat-icon>add</mat-icon>
                    Eintrag hinzufügen
                  </button>
                </header>
                <div class="history-list">
                  @if (row.history.length === 0) {
                    <p class="history-empty">Keine historischen Einträge vorhanden.</p>
                  } @else {
                    @for (entry of row.history; track entry.id) {
                      <div class="history-entry">
                        <input
                          type="date"
                          [ngModel]="entry.validFrom"
                          (ngModelChange)="updateHistoryEntry(row.key, entry.id, 'validFrom', $event || '')"
                        />
                        <input
                          type="text"
                          [ngModel]="entry.value"
                          (ngModelChange)="updateHistoryEntry(row.key, entry.id, 'value', $event || '')"
                        />
                        <div class="history-entry__actions">
                          <button
                            mat-icon-button
                            type="button"
                            (click)="moveHistoryEntry(row.key, entry.id, -1)"
                            [disabled]="isFirstHistoryEntry(row.key, entry.id)"
                            matTooltip="Nach oben"
                          >
                            <mat-icon>arrow_upward</mat-icon>
                          </button>
                          <button
                            mat-icon-button
                            type="button"
                            (click)="moveHistoryEntry(row.key, entry.id, 1)"
                            [disabled]="isLastHistoryEntry(row.key, entry.id)"
                            matTooltip="Nach unten"
                          >
                            <mat-icon>arrow_downward</mat-icon>
                          </button>
                          <button
                            mat-icon-button
                            type="button"
                            color="warn"
                            (click)="removeHistoryEntry(row.key, entry.id)"
                            matTooltip="Eintrag löschen"
                          >
                            <mat-icon>delete</mat-icon>
                          </button>
                        </div>
                      </div>
                    }
                  }
                </div>
                <div class="history-panel__actions">
                  <button mat-stroked-button type="button" (click)="toggleHistory(row.key)">
                    Schließen
                  </button>
                  <button mat-flat-button color="primary" type="button" (click)="saveRow(row.key)">
                    Änderungen übernehmen
                  </button>
                </div>
              </div>
            </td>
          </tr>
        }
      }
    </tbody>
  </table>
</div>
}
