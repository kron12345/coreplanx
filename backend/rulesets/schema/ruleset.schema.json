{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "CorePlanX Ruleset",
  "type": "object",
  "additionalProperties": false,
  "required": ["id", "version"],
  "properties": {
    "id": { "type": "string", "minLength": 1 },
    "version": { "type": "string", "minLength": 1 },
    "label": { "type": "string" },
    "description": { "type": "string" },
    "includes": {
      "type": "array",
      "items": { "$ref": "#/definitions/include" }
    },
    "conditions": {
      "type": "array",
      "items": { "$ref": "#/definitions/condition" }
    },
    "hardConstraints": {
      "type": "array",
      "items": { "$ref": "#/definitions/constraint" }
    },
    "softConstraints": {
      "type": "array",
      "items": { "$ref": "#/definitions/softConstraint" }
    },
    "objectives": {
      "type": "array",
      "items": { "$ref": "#/definitions/objective" }
    },
    "actions": {
      "type": "array",
      "items": { "$ref": "#/definitions/action" }
    },
    "templates": {
      "type": "array",
      "items": { "$ref": "#/definitions/template" }
    }
  },
  "definitions": {
    "include": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "version"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "version": { "type": "string", "minLength": 1 }
      }
    },
    "condition": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "expr"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "expr": { "$ref": "#/definitions/expression" }
      }
    },
    "constraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "constraint"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "when": { "$ref": "#/definitions/expression" },
        "constraint": { "$ref": "#/definitions/constraintDef" }
      }
    },
    "softConstraint": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "constraint", "penalty"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "when": { "$ref": "#/definitions/expression" },
        "constraint": { "$ref": "#/definitions/constraintDef" },
        "penalty": { "$ref": "#/definitions/penalty" }
      }
    },
    "objective": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "term", "weight"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "when": { "$ref": "#/definitions/expression" },
        "term": { "$ref": "#/definitions/constraintDef" },
        "weight": { "type": "number" }
      }
    },
    "action": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "action"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "when": { "$ref": "#/definitions/expression" },
        "action": { "$ref": "#/definitions/actionDef" }
      }
    },
    "template": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "template"],
      "properties": {
        "id": { "type": "string", "minLength": 1 },
        "description": { "type": "string" },
        "when": { "$ref": "#/definitions/expression" },
        "template": { "$ref": "#/definitions/templateDef" }
      }
    },
    "constraintDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": { "type": "string", "minLength": 1 },
        "params": { "type": "object", "additionalProperties": true }
      }
    },
    "penalty": {
      "type": "object",
      "additionalProperties": false,
      "required": ["weight"],
      "properties": {
        "weight": { "type": "number", "minimum": 0 },
        "maxPenalty": { "type": "number", "minimum": 0 }
      }
    },
    "actionDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "insert_break",
            "insert_travel",
            "create_duty",
            "split_duty",
            "shift_activity",
            "set_duty_start_end"
          ]
        },
        "params": { "type": "object", "additionalProperties": true }
      }
    },
    "templateDef": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["break", "travel", "duty", "duty_split", "shift", "assignment_swap"]
        },
        "params": { "type": "object", "additionalProperties": true }
      }
    },
    "expression": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["op", "args"],
          "properties": {
            "op": { "enum": ["and", "or"] },
            "args": {
              "type": "array",
              "minItems": 1,
              "items": { "$ref": "#/definitions/expression" }
            }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["op", "arg"],
          "properties": {
            "op": { "const": "not" },
            "arg": { "$ref": "#/definitions/expression" }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["op", "left", "right"],
          "properties": {
            "op": { "enum": ["eq", "ne", "gt", "gte", "lt", "lte", "in"] },
            "left": { "$ref": "#/definitions/operand" },
            "right": { "$ref": "#/definitions/operand" }
          }
        }
      ]
    },
    "operand": {
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["var"],
          "properties": {
            "var": { "type": "string", "minLength": 1 }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["value"],
          "properties": {
            "value": {
              "anyOf": [
                { "type": "string" },
                { "type": "number" },
                { "type": "boolean" },
                { "type": "null" },
                {
                  "type": "array",
                  "items": {
                    "anyOf": [
                      { "type": "string" },
                      { "type": "number" },
                      { "type": "boolean" }
                    ]
                  }
                }
              ]
            }
          }
        }
      ]
    }
  }
}
